<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>การสร้างฟอร์มอัพโหลดแบบง่ายๆ | Yii 2 Learning</title>
	<meta name="description" content="การสร้างฟอร์มอัพโหลดแบบง่ายๆ | การสร้างฟอร์มอัพโหลดไฟล์ ปกติเป็นเรื่องที่ยุ่งยากพอสมควรหากเขียนด้วย php ธรรมดา เพราะต้องจัดการหลายๆ ส่วนมากๆ แต่เราโชคดี! ^ ^ เพราะใช้ Yii Framework เราสามา... Yii2, Yii Framework, Extension, Howto,tutorial">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/jekyll-github.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://dixonsatit.github.io/2015/09/22/basic-upload.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Yii 2 Learning" href="http://dixonsatit.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-63817549-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7037e0cdf96cd3d4ad39b6c32ca29bd7?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Yii 2 Learning</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			<li>
				<a class="page-link" href="/yii2-learning/">
					Table Of Contents
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			


<li>
	<a href="mailto:dixonsatit@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>









<li>
	<a href="https://www.facebook.com/yii2Learning" title="Follow on Facebook">
		<i class="fa fa-fw fa-facebook"></i>
	</a>
</li>





<li>
	<a href="https://github.com/dixonsatit" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/dixonsatit" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">การสร้างฟอร์มอัพโหลดแบบง่ายๆ</h1>
    <p class="meta">
    September 22, 2015
    
    </p>
  </header>
  <section class="post-content"><p>การสร้างฟอร์มอัพโหลดไฟล์ ปกติเป็นเรื่องที่ยุ่งยากพอสมควรหากเขียนด้วย php ธรรมดา เพราะต้องจัดการหลายๆ ส่วนมากๆ แต่เราโชคดี! ^ ^ เพราะใช้ Yii Framework เราสามารถสร้างฟอร์ม เพื่อแนบไฟล์ เช่นรูปภาพหรือไฟล์ต่างๆ ได้โดยง่ายโดยใช้ <a href="http://www.yiiframework.com/doc-2.0/yii-web-uploadedfile.html">yii\web\UploadedFile</a> ซึ่งจะต้องใช้งานร่วมกันกับ <a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activeform.html">Activeform</a> และ <a href="http://www.yiiframework.com/doc-2.0/guide-structure-models.html">Model</a> โดยผมมีตัวอย่างการสร้างฟอร์มอัพโหลดทั้ง 2 แบบคือ</p>

<ul>
<li>แบบทีละไฟล์ (Uploading single File)</li>
<li>แบบทีละหลายๆ ไฟล์ (Uploading multiple files)</li>
</ul>

<p>จุดประสงค์หลักๆ คืออยากให้เราเข้าใจหลักการทำงานของการอัพโหลดไฟล์แบบพื้นฐานที่มากับ Yii Framework เมื่อเข้าใจหลักการทำงานดีแล้ว เราจะไปใช้พวก extension อื่นๆ ก็สามารถทำได้สบายๆ และรู้ว่าจะต้องไปปรับแต่งอะไรตรงใหนเพื่อให้ใช้กับงานของเราได้</p>

<h1 id="ส่วนประกอบในการสร้างฟอร์มอัพโหลด">ส่วนประกอบในการสร้างฟอร์มอัพโหลด</h1>

<p>ในการสร้างฟอร์มอัพโหลดจะต้องประกอบไปด้วย 3 ส่วนดังต่อไปนี้</p>

<ul>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activeform.html">Activeform</a> เป็นตัวรับข้อมูลจากผู้ใช้งาน ว่าทำการเลือกไฟล์อะไร หรือข้อมูลอื่นๆ</li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-web-uploadedfile.html">UploadedFile</a> เป็นพระเอกของเรา มีหน้าที่นำไฟล์ที่เราเลือกไปอัพโหลดเก็บไว้บน Server ของเรา</li>
<li><a href="http://www.yiiframework.com/doc-2.0/guide-structure-models.html">Model</a> เป็นผู้ช่วยที่ทำให้เราสามารถ validate ข้อมูลต่างๆ ได้เช่น ให้เลือกได้เฉพาะไฟล์รูปภาพเท่านั้น, การจำกัดขนาดไฟล์ที่อัพโหลด, การระบุจำนวนไฟล์ที่ให้อัพโหลดเป็นต้น</li>
</ul>

<p>เมื่อเตรียมส่วนประกอบต่างๆ ครบแล้วก็ไปลุยสร้างของจริงกันเลยครับ</p>

<h1 id="หลักการทำงานของการอัพโหลดไฟล์">หลักการทำงานของการอัพโหลดไฟล์</h1>

<p><img src="/img/basic-upload.jpg" alt=""></p>

<p>ขั้นตอนหลักๆ จะเริ่มจากผู้ใช้งาน</p>

<ul>
<li>กรอกข้อมูลต่างๆ เลือกไฟล์ที่ต้องการอัพโหลด</li>
<li>ตัว Activeform จะทำงานร่วมกับ model เพื่อ validate ข้อมูลที่กรอกและเลือกเข้ามาโดยใช้ข้อมูลจาก model ที่เราได้กำหนดในส่วน rule() เพื่อ validate ข้อมูล</li>
<li>เมื่อตรวจสอบข้อมูลถูกต้องตามกฎที่เราได้กำหนดไว้ใน model ข้อมูลจะถูกส่งไปที่ UploadedFile เพื่อนำไฟล์ไปทำการอัพโหลดบันทึกเก็บไว้ที่ Server</li>
<li>ในส่วนของตารางข้อมูลจะเก็บไว้เพียงชื่อไฟล์เท่านั้น</li>
</ul>

<h1 id="สร้างฟอร์มอัพโหลด">สร้างฟอร์มอัพโหลด</h1>

<p>ตัวอย่างนี้ผมจะสร้างตารางขึ้นมาง่ายๆ เพื่อเก็บข้อมูล ชื่อ,นามสกุล,รูปภาพ เพื่อรับข้อมูลและสร้างฟอร์มอัพโหลดไฟล์รูปภาพ โครงสร้างมีดังนี้</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">easy_upload</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">surname</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">photo</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">photos</span><span class="o">`</span> <span class="nb">text</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>
</code></pre></div>
<ul>
<li>สร้างตาราง <code>easy_upload</code> ตามโครงสร้างด้านบน</li>
<li>gii model จากตาราง <code>easy_upload</code> และ gii crud</li>
<li>ทดลองเข้าใช้งาน</li>
</ul>

<p><img src="/img/easy-upload-index.png" alt=""></p>

<h2 id="ตั้งค่า-model-validation">ตั้งค่า Model Validation</h2>

<p>ในส่วนของ model เราจะต้องกำหนดค่า validate ของฟิวด์ <code>photo</code> ให้เป็น file เพื่อทำการตรวจสอบข้อมูลก่อนอัพโหลด เช่น เป็นรูปภาพ,เป็นไฟล์</p>

<p>เปิดไฟล์ model <code>EasyUpload.php</code> ขึ้นมา เพิ่ม validate <code>file</code> ให้กับฟิวด์ <code>photo</code> ในฟังก์ชัน rules() และมีการระบุ <code>extensions</code> นามสกุลไฟล์ที่สามารถอัพโหลดได้คือ png,jpg ส่วน <code>skipOnEmpty</code> คือหากไม่มีการอัพโหลดก็ให้มาข้ามในส่วนของ upload ไป</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">backend\models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Yii</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\yii\web\UploadedFile</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">EasyUpload</span> <span class="k">extends</span> <span class="nx">\yii\db\ActiveRecord</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$upload_foler</span> <span class="o">=</span><span class="s1">&#39;uploads&#39;</span><span class="p">;</span>

<span class="c1">// ....</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;required&#39;</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;photo&#39;</span><span class="p">],</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
          <span class="s1">&#39;skipOnEmpty&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
          <span class="s1">&#39;extensions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;png,jpg&#39;</span>
        <span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">upload</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="nv">$attribute</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$photo</span>  <span class="o">=</span> <span class="nx">UploadedFile</span><span class="o">::</span><span class="na">getInstance</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="nv">$attribute</span><span class="p">);</span>
      <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUploadPath</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$photo</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$fileName</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$photo</span><span class="o">-&gt;</span><span class="na">baseName</span><span class="o">.</span><span class="nb">time</span><span class="p">())</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="o">-&gt;</span><span class="na">extension</span><span class="p">;</span>
        <span class="c1">//$fileName = $photo-&gt;baseName . &#39;.&#39; . $photo-&gt;extension;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$photo</span><span class="o">-&gt;</span><span class="na">saveAs</span><span class="p">(</span><span class="nv">$path</span><span class="o">.</span><span class="nv">$fileName</span><span class="p">)){</span>
          <span class="k">return</span> <span class="nv">$fileName</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getOldAttribute</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getUploadPath</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">getAlias</span><span class="p">(</span><span class="s1">&#39;@webroot&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_foler</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getUploadUrl</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">getAlias</span><span class="p">(</span><span class="s1">&#39;@web&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_foler</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getPhotoViewer</span><span class="p">(){</span>
  <span class="k">return</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">photo</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">getAlias</span><span class="p">(</span><span class="s1">&#39;@web&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/img/none.png&#39;</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUploadUrl</span><span class="p">()</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">photo</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ...</span>

<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>สร้างโฟลเดอร์ uploads ที่ <code>web/uploads</code> เพื่อเอาไว้เก็บไฟล์ที่อัพโหลดขึ้นไป</p>
</blockquote>

<h3 id="ลำดับการทำงานของฟังก์ชัน-upload">ลำดับการทำงานของฟังก์ชัน upload()</h3>

<ul>
<li>เรียกข้อมูลรูปภาพที่แนบมากับฟอร์มโดยใช้  <code>UploadedFile::getInstance()</code></li>
<li>ทำการตรวจสอบข้อมูลที่ส่งมาด้วย $this-&gt;validate() จริงๆ ตรงนี้ไม่ต้องมีก็ได้ แต่เรียกไว้เผื่อเรานำไปใช้ในส่วนที่ไม่ได้มีการ save ข้อมูลในตาราง</li>
<li>เปลี่ยนชื่อไฟล์</li>
<li>บันทึกไฟล์ลง server ด้วยคำสั่ง saveAs()</li>
<li>ถ้าบันทึกสำเร็จจะส่งชื่อไฟล์กลับไป ถ้าไม่สำเร็จจะส่งค่า false ไปแทน</li>
<li>ถ้าหากเป็นการอัพเดทฟอร์ม หากอัพโหลดภาพใหม่สำเร็จจะใช้ชื่อไฟล์ใหม่ แต่ถ้าไม่สำเร็จจะใช้ค่าเดิมที่มาจาก db</li>
</ul>

<h2 id="ตั้งค่า-activeform-ให้สามารถอัพโหลดไฟล์ได้">ตั้งค่า Activeform ให้สามารถอัพโหลดไฟล์ได้</h2>

<p>ให้ไปที่ไฟล์ view <code>easy-upload/_form.php</code>  ทำการเพิ่ม enctype เพื่อให้สามารถแนบไฟล์ไปกับฟอร์มได้</p>

<blockquote>
<p>หลายคนตกม้าตายเพราะลืมตั้งค่าส่วนนี้ T_T&#39; ซึ่งผมก็เป็นหนึ่งในนั้น</p>
</blockquote>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">begin</span><span class="p">([</span>
    <span class="s1">&#39;options&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;enctype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">]</span>
  <span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h2 id="เปิดใช้-fileinput">เปิดใช้ fileInput</h2>

<p>เรียกใช้งาน fileInput เพื่อให้สามารถเลือกไฟล์เพื่ออัพโหลดข้อมูลได้ และทำการจัดแต่ง layout</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">  </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;photo&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fileInput</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>โค้ด _form.php ทั้งหมด</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">yii\helpers\Html</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\widgets\ActiveForm</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;div class=&quot;easy-upload-form&quot;&gt;</span>
<span class="x">  </span><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">begin</span><span class="p">([</span>
      <span class="s1">&#39;options&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;enctype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">]</span>
    <span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">      &lt;div class=&quot;col-md-2&quot;&gt;</span>
<span class="x">        &lt;div class=&quot;well text-center&quot;&gt;</span>
<span class="x">          </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">img</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getPhotoViewer</span><span class="p">(),[</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:100px;&#39;</span><span class="p">,</span><span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;img-rounded&#39;</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">      &lt;div class=&quot;col-md-10&quot;&gt;</span>
<span class="x">            </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;photo&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fileInput</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">        </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">submitButton</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;Create&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;Update&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="s1">&#39;btn btn-success&#39;</span> <span class="o">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    </span><span class="cp">&lt;?php</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">end</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;/div&gt;</span>
</code></pre></div>
<p>เมื่อลองรันหน้าฟอร์มจะได้แบบนี้</p>

<p><img src="/img/easy-upload-form.png" alt=""></p>

<blockquote>
<p>รูปภาพ none.png <a href="/img/none.png">download</a> ได้ที่นี่ นำไปไว้ที่ <code>web/img/none.png</code></p>
</blockquote>

<h2 id="แก้ไข-easyuploadcontroller-php">แก้ไข EasyUploadController.php</h2>

<p>ให้เปิดไฟล์ controllers/EasyUploadController.php ของเราขึ้นมาแล้วทำการแก้ไข actionCreate &amp; actionUpdate ดังนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// ....</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EasyUpload</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photo</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photo&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">public</span> <span class="k">function</span> <span class="nf">actionUpdate</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findModel</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photo</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photo&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>จากนั้นให้ลองทำการ upload file ดู ลองในส่วนของการบันทึกตอนอัพเดทด้วยว่า หากไม่ได้อัพโหลดไฟล์หลังจากบันทึกไฟล์เก่าต้องยังคงอยู่ มันจะเปลี่ยนก็ต่อเมื่อมีการอัพโหลดไฟล์ใหม่เข้าไปแทนที่ค่าเดิม</p>

<h2 id="ปรับปรุงการแสดงผลที่-actionindex">ปรับปรุงการแสดงผลที่ actionIndex()</h2>

<p>กำหนดให้แสดงภาพใน  GridView ได้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">GridView</span><span class="o">::</span><span class="na">widget</span><span class="p">([</span>
    <span class="s1">&#39;dataProvider&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dataProvider</span><span class="p">,</span>
    <span class="s1">&#39;filterModel&#39;</span> <span class="o">=&gt;</span> <span class="nv">$searchModel</span><span class="p">,</span>
    <span class="s1">&#39;columns&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">//[&#39;class&#39; =&gt; &#39;yii\grid\SerialColumn&#39;],</span>
        <span class="p">[</span>
            <span class="s1">&#39;options&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:150px;&#39;</span><span class="p">],</span>
            <span class="s1">&#39;format&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="o">=&gt;</span><span class="k">function</span><span class="p">(</span><span class="nv">$model</span><span class="p">){</span>
              <span class="k">return</span> <span class="nx">Html</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,[</span>
                <span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:150px;height:95px;</span>
<span class="s1">                          border-top: 10px solid rgba(255, 255, 255, .46);</span>
<span class="s1">                          background-image:url(&#39;</span><span class="o">.</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photoViewer</span><span class="o">.</span><span class="s1">&#39;);</span>
<span class="s1">                          background-size: cover;</span>
<span class="s1">                          background-position:center center;</span>
<span class="s1">                          background-repeat:no-repeat;</span>
<span class="s1">                          &#39;</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="c1">//&#39;id&#39;,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surname&#39;</span><span class="p">,</span>
        <span class="c1">// &#39;photo&#39;,</span>
        <span class="c1">// &#39;photos:ntext&#39;,</span>

        <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yii\grid\ActionColumn&#39;</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><img src="/img/easy-upload-index-preview.png" alt=""></p>

<h2 id="ปรับปรุงการแสดงผลที่-actionview">ปรับปรุงการแสดงผลที่ actionView()</h2>

<p>กำหนดให้แสดงภาพใน  DetailView ได้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">DetailView</span><span class="o">::</span><span class="na">widget</span><span class="p">([</span>
    <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
    <span class="s1">&#39;attributes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surname&#39;</span><span class="p">,</span>
        <span class="c1">//&#39;photoViewer:image&#39;,</span>
        <span class="p">[</span>
            <span class="s1">&#39;format&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="o">=&gt;</span><span class="nx">Html</span><span class="o">::</span><span class="na">img</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photoViewer</span><span class="p">,[</span><span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;img-thumbnail&#39;</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:200px;&#39;</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">],</span>
<span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><img src="/img/easy-upload-view.png" alt=""></p>

<h1 id="การอัพโหลดทีละหลายๆ-ไฟล์">การอัพโหลดทีละหลายๆ ไฟล์</h1>

<p>เราสามารถอัพโหลดไฟล์ทีละหลายๆ ไฟล์ได้ โดยใช้ <code>UploadedFile::getInstances()</code> ซึ่งวิธีเป็นตัวอย่างง่ายๆ ยังไม่มีในส่วนของการลบไฟล์ จริงๆ แล้วการอัพโหลดทีละหลายๆ ไฟล์ควรมีตารางเก็บจะสะดวกกว่ามาก แต่ตัวอย่างนี้ จะนำเสนอว่าหลักการทำงานของการอัพโหลดทีละหลายๆ ไฟล์นั้นเป็นยังไง เพื่อให้เข้าใจหลักการทำงานและสามารถนำไปพัฒนาต่อยอดได้ ให้ทำการเพิ่มเติมโค้ดในส่วนที่เหลือดังนี้</p>

<h2 id="แก้ไข-model-easyupload-php">แก้ไข model EasyUpload.php</h2>

<p>เพิ่มฟังก์ชัน uploadMultiple() เพื่อบันทึกทีละหลายๆ ไฟล์ และเก็บข้อมูลในรูปแบบ string คั่นด้วยคอมม่า (,) แบบนี้ &#39;xxxx.jpg,xxxx.png&#39;</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">//...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;required&#39;</span><span class="p">],</span>
            <span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">],</span>
            <span class="p">[[</span><span class="s1">&#39;photo&#39;</span><span class="p">],</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
              <span class="s1">&#39;skipOnEmpty&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
              <span class="s1">&#39;extensions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;png,jpg&#39;</span>
            <span class="p">],</span>
            <span class="p">[[</span><span class="s1">&#39;photos&#39;</span><span class="p">],</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
              <span class="s1">&#39;skipOnEmpty&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
              <span class="s1">&#39;maxFiles&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
              <span class="s1">&#39;extensions&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;png,jpg&#39;</span>
            <span class="p">]</span>
        <span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">uploadMultiple</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="nv">$attribute</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nv">$photos</span>  <span class="o">=</span> <span class="nx">UploadedFile</span><span class="o">::</span><span class="na">getInstances</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="nv">$attribute</span><span class="p">);</span>
      <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUploadPath</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$photos</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$filenames</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">foreach</span> <span class="p">(</span><span class="nv">$photos</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">baseName</span><span class="o">.</span><span class="nb">time</span><span class="p">())</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">extension</span><span class="p">;</span>
                  <span class="k">if</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">saveAs</span><span class="p">(</span><span class="nv">$path</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">)){</span>
                    <span class="nv">$filenames</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
                  <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$filenames</span><span class="p">);</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,(</span><span class="nx">ArrayHelper</span><span class="o">::</span><span class="na">merge</span><span class="p">(</span><span class="nv">$filenames</span><span class="p">,</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getOwnPhotosToArray</span><span class="p">())));</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getOldAttribute</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPhotosViewer</span><span class="p">(){</span>
      <span class="nv">$photos</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">photos</span> <span class="o">?</span> <span class="o">@</span><span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">photos</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
      <span class="nv">$img</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$photos</span> <span class="k">as</span>  <span class="nv">$photo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$img</span><span class="o">.=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nx">Html</span><span class="o">::</span><span class="na">img</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUploadUrl</span><span class="p">()</span><span class="o">.</span><span class="nv">$photo</span><span class="p">,[</span><span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;img-thumbnail&#39;</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;max-width:100px;&#39;</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nv">$img</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOwnPhotosToArray</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getOldAttribute</span><span class="p">(</span><span class="s1">&#39;photos&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="o">@</span><span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getOldAttribute</span><span class="p">(</span><span class="s1">&#39;photos&#39;</span><span class="p">))</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="p">}</span>
</code></pre></div>
<h2 id="แก้ไข-_form-php">แก้ไข _form.php</h2>

<p>เพิ่มเติมส่วนนี้เข้าไป</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;photos[]&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fileInput</span><span class="p">([</span><span class="s1">&#39;multiple&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;div class=&quot;well&quot;&gt;</span>
<span class="x">  </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getPhotosViewer</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
</code></pre></div>
<p><img src="/img/easy-uploads-form.png" alt=""></p>

<h2 id="แก้ไข-view-php">แก้ไข  view.php</h2>

<p>เพิ่มในส่วนของการเรียกแสดงผลรูปภาพทีละหลายๆ ไฟล์</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">DetailView</span><span class="o">::</span><span class="na">widget</span><span class="p">([</span>
    <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
    <span class="s1">&#39;attributes&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surname&#39;</span><span class="p">,</span>
        <span class="c1">//&#39;photoViewer:image&#39;,</span>
        <span class="p">[</span>
            <span class="s1">&#39;format&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="o">=&gt;</span><span class="nx">Html</span><span class="o">::</span><span class="na">img</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photoViewer</span><span class="p">,[</span><span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;img-thumbnail&#39;</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:200px;&#39;</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="s1">&#39;format&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;photos&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="o">=&gt;</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getPhotosViewer</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">],</span>
<span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p><img src="/img/easy-uploads-view.png" alt=""></p>

<h2 id="แก้ไข-easyuploadcontroller-php">แก้ไข EasyUploadController.php</h2>

<p>เรียกใช้งาน uploadMultiple() เพิ่มเติมเข้าไป ทั้ง create &amp; update</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">//...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EasyUpload</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photo</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photo&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photos</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">uploadMultiple</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photos&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionUpdate</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findModel</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photo</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photo&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">photos</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">uploadMultiple</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span><span class="s1">&#39;photos&#39;</span><span class="p">);</span>
        <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="สรุปความเข้าใจ">สรุปความเข้าใจ</h1>

<p>การใช้งานอัพโหลดไฟล์จะมีแค่ 2 แบบคือ
- อัพโหลดทีละไฟล์ใช้ <code>UploadedFile::getInstance()</code>
- อัพโหลดทีละหลายๆ ไฟล์ใช้ <code>UploadedFile::getInstances()</code></p>

<p>หลักๆ ในการอัพโหลดไฟล์ก็จะมีแค่นี้ นอกนั้นจะเป็นการปรับแต่งให้ใช้งานง่ายๆ ซึ่งจะต้องใช้ extension อื่นๆ เข้ามาใช้งานเพิ่มเติม หวังว่าบทความนี้คงจะทำให้เราเข้าใจพื้นฐานการอัพโหลดไฟล์นะครับ <sup>^</sup></p>

<p>ตัวอย่างโค้ด</p>

<ul>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/blob/master/backend/controllers/EasyUploadController.php">controller</a></li>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/blob/master/backend/models/EasyUpload.php">Model</a></li>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/tree/master/backend/views/easy-upload">views</a></li>
</ul>

<p>@dixonSatit</p>
</section>
</article>

<!-- Post navigation -->


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'dixonsatit';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
<script src="/js/main.js"></script>


<footer class="site-footer">

	<h6 style="font-weight:normal;">เครือข่ายพันธมิตรของเรา <small></small></h6>
	<a href="http://cloud-tutorial.com" target="_blank">
		<img src="http://cloud-tutorial.com/wp-content/uploads/2015/04/new-logo-sm.png" alt="cloud-tutorial.com" />
	</a>
	<hr>
	<p class="text"><a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/"><img alt="สัญญาอนุญาตของครีเอทีฟคอมมอนส์" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/th/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Yii2 Learning</span> โดย <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.dimpled.me" property="cc:attributionName" rel="cc:attributionURL">Sathit Seethaphon</a> บทความต่างๆ ในเว็บไซต์ อนุญาตให้นำไปเผยแพร่ได้ โดยต้องอ้างอิงที่มาและไม่ใช้เพื่อการค้า <br>ตาม<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/" > สัญญาอนุญาตของครีเอทีฟคอมมอนส์แบบ แสดงที่มา-ไม่ใช้เพื่อการค้า 3.0 ประเทศไทย</a>.<br> Powered by <a href="http://jekyllrb.com">Jekyll</a> with <a href="https://rohanchandra.github.io/project/type/">Type Theme</a>
</p>
</footer>


  </body>
</html>

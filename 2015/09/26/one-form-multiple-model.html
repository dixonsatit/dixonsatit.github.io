<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>การสร้างฟอร์มที่สามารถบันทึกพร้อมกันได้ทีละหลายๆ Model | Yii 2 Learning</title>
	<meta name="description" content="การสร้างฟอร์มที่สามารถบันทึกพร้อมกันได้ทีละหลายๆ Model | ปกติการสร้างฟอร์มเพื่อบันทึกและแก้ไขข้อมูลนั้น เราจะทำเพียงแค่ครั้งละ 1  Model  แต่ก็มีในบางครั้งที่เราจำเป็นจะต้องบันทึกพร้อมกันทีละหลายๆ  model ซึ่งใน Yii ... Yii2, Yii Framework, Extension, Howto,tutorial">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/jekyll-github.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://dixonsatit.github.io/2015/09/26/one-form-multiple-model.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Yii 2 Learning" href="http://dixonsatit.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-63817549-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7037e0cdf96cd3d4ad39b6c32ca29bd7?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Yii 2 Learning</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			<li>
				<a class="page-link" href="/yii2-learning/">
					Table Of Contents
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			


<li>
	<a href="mailto:dixonsatit@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>









<li>
	<a href="https://www.facebook.com/yii2Learning" title="Follow on Facebook">
		<i class="fa fa-fw fa-facebook"></i>
	</a>
</li>





<li>
	<a href="https://github.com/dixonsatit" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/dixonsatit" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">การสร้างฟอร์มที่สามารถบันทึกพร้อมกันได้ทีละหลายๆ Model</h1>
    <p class="meta">
    September 26, 2015
    
    </p>
  </header>
  <section class="post-content"><p>ปกติการสร้างฟอร์มเพื่อบันทึกและแก้ไขข้อมูลนั้น เราจะทำเพียงแค่ครั้งละ 1  Model  แต่ก็มีในบางครั้งที่เราจำเป็นจะต้องบันทึกพร้อมกันทีละหลายๆ  model ซึ่งใน Yii 2 นั้นสามารถทำได้ง่ายๆ เลย จะทำกี่ model ก็ได้ ส่วนใหญ่จะเป็นตารางที่มีการเชื่อมกัน (Relation) อยู่แล้ว</p>

<h1 id="โครงสร้างและหลักการทำงาน">โครงสร้างและหลักการทำงาน</h1>

<p>การทำงานจะเหมือนกันทั้งสองแบบ ต่างกันแค่เรื่องของการ validate ข้อมูลเท่านั้น ซึ่งปกติจะใช้ฟังก์ชัน validate() ผ่าน model แต่ถ้าหากต้องบันทึกพร้อมกันทีละหลายๆ model จะต้องใช้ validateMultiple() แทน ลองดูความแตกต่างตามภาพ</p>

<h2 id="single-model">Single model</h2>

<p><img src="/img/sigleModel.jpg" alt=""></p>

<p>ในการบันทึกข้อมูลปกติจะมีอยู่ 4 ขั้นตอนคือ</p>

<ul>
<li><code>$model = new SomeModel()</code> แล้วนำไปแสดงผลเป็นฟอร์มเพื่อรับข้อมูล</li>
<li>เมื่อมีการ submit จะรับข้อมูลจากฟอร์มโดยใช้ฟังก์ชัน <code>$model-&gt;load()</code></li>
<li>ตรวจสอบข้อมูลที่โหลดเข้ามาโดยใช้ <code>$model-&gt;validate()</code></li>
<li>นำข้อมูลที่ได้ไปบันทึก</li>
</ul>

<h2 id="multiple-model">Multiple model</h2>

<p><img src="/img/mulipleModel.jpg" alt=""></p>

<p>เมื่อลองเปรียบเทียบกันดูจะเห็นความแตกต่าง 2 จุดคือ ปกติจะใช้ฟังก์ชัน validat() ใน model แต่ถ้าหากเป็นทีละหลายๆ model จะใช้ Model::validateMultiple()   แทน ซึ่ง validate() แบบเดิมจะไม่สามารถ validate ได้ทีละหลายๆ model
ในการบันทึกข้อมูลจะมีอยู่ 4 ขั้นตอนคือ</p>

<ul>
<li><code>$model = new ModelA(), $model = new ModelB()</code> แล้วนำไปแสดงผลเป็นฟอร์มเพื่อรับข้อมูล</li>
<li>เมื่อมีการ submit จะรับข้อมูลจากฟอร์มโดยใช้ฟังก์ชัน <code>$modelA-&gt;load(),$modelB-&gt;load()</code> แยกกัน</li>
<li>ตรวจสอบข้อมูลที่โหลดเข้ามาโดยใช้ <code>Model::validateMultiple()</code> ร่วมกันทั้ง 2 model</li>
<li>นำข้อมูลที่ได้ไปบันทึก</li>
</ul>

<blockquote>
<p>ปกติในการใช้งานเราจะไม่เห็นการเรียกใช้งานฟังก์ชัน validate() เพราะมันถูกเรียกใช้งานอยู่ภายในฟังก์ชัน save() อยู่แล้ว</p>
</blockquote>

<h1 id="ลงมือสร้างฟอร์ม">ลงมือสร้างฟอร์ม</h1>

<p>ตัวอย่างนี้เราจะลองสร้างตาราง 2 ตารางแบบง่ายๆ  โดยตารางแรกชื่อ m_user เก็บข้อมูล username,email ตารางที่ 2 m_emp เก็บข้อมูล คำนำหน้า,ชื่อ,นามสกุล  ซึ่งตาราง m_emp จะเก็บข้อมูล user_id เพื่อ relation กับ m_user  ด้วย id   และเมื่อมีการบันทึกข้อมูลเราจะให้มันสามารถบันทึกทั้ง 2 ตารางได้พร้อมกัน</p>

<p>ให้สร้างตารางตามโครงสร้างนี้</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">m_user</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">email</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">m_emp</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">title</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">surname</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>
</code></pre></div>
<p>จากนั้นให้สร้าง model ด้วย gii ทั้ง 2 ตาราง เป็น MUser,MEmp  หลังจากสร้าง model เสร็จให้ gii สร้าง crud ตาราง m_emp ต่อเพื่อสร้างฟอร์มเพิ่มลบแก้ไข แต่ไม่ต้องสร้าง crud ของ m_user เพราะเราจะนำไปรวมที่ฟอร์ม m_emp  ทดลองเข้าใช้งาน <code>index?r=m-emp/index</code> ว่าสามารถใช้งานได้ทุกอย่างเพิ่ม, ลบ, แก้ไข</p>

<h1 id="ปรับปรุงส่วนต่างๆ">ปรับปรุงส่วนต่างๆ</h1>

<p>ส่วนแรกที่ต้องปรับปรุงคือ actionCreate() ไปที่ไฟล์ controllers/MEmpController.php</p>

<h2 id="ปรับปรุง-actioncreate-ใน-mempcontroller-php">ปรับปรุง actionCreate() ใน MEmpController.php</h2>

<p>ของเดิมจะ new object ขึ้นมาแค่ตัวเดียวคือ MEmp()</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MEmp</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ปรับปรุงใหม่โดย use MUser เพิ่มเติมด้านบนสุด</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">backend\models\MUser</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$modelEmp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MEmp</span><span class="p">();</span>
    <span class="nv">$modelUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MUser</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="nv">$modelEmp</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
       <span class="nv">$modelUser</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
       <span class="nx">Model</span><span class="o">::</span><span class="na">validateMultiple</span><span class="p">([</span><span class="nv">$modelEmp</span><span class="p">,</span><span class="nv">$modelUser</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$modelUser</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">()){</span>
          <span class="nv">$modelEmp</span><span class="o">-&gt;</span><span class="na">user_id</span> <span class="o">=</span> <span class="nv">$modelUser</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
          <span class="nv">$modelEmp</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$modelEmp</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$modelEmp</span><span class="p">,</span>
            <span class="s1">&#39;modelUser&#39;</span><span class="o">=&gt;</span><span class="nv">$modelUser</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>สังเกตว่าเราจะต้อง new object ที่ต้องการขึ้นมาจะใช้กี่ตัวในฟอร์มก็ต้อง new object ตามจำนวนที่ต้องการ จากนั้นจะส่ง model ไปแสดงผลที่ฟอร์ม</p>

<p>เมื่อมีการ กด submit เข้ามาจะสังเกตว่า model จะเรียกข้อมูลที่ submit เข้ามาด้วยฟังก์ชัน load() ของใครของมัน จากนั้นก็เรียก <code>Model::validateMultiple()</code>  เพื่อ validate ข้อมูล</p>

<p>เมื่อ validate เสร็จเรียบร้อย ก็นำข้อมูลที่ได้ผ่านการตรวจสอบแล้วนำไปบันทึกโดยเราจะให้ MUser บันทึกก่อนเพราะว่า MEmp ต้องใช้ user_id ซึ่งเป็น pk ของ MUser จากนั้นก็จะสามารถบันทึกได้ทั้ง 2 ตาราง</p>

<h2 id="ปรับปรุง-views-m-emp-_form-php">ปรับปรุง views/m-emp/_form.php</h2>

<p>เราจะทำการเรียกฟอร์มของ user เข้าไปด้วยโดยใช้ตัวแปร $modelUser และทำการปรับปรุง layout เล็กน้อย</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">yii\helpers\Html</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\widgets\ActiveForm</span><span class="p">;</span>

<span class="cm">/* @var $this yii\web\View */</span>
<span class="cm">/* @var $model backend\models\MEmp */</span>
<span class="cm">/* @var $form yii\widgets\ActiveForm */</span>
<span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;div class=&quot;memp-form&quot;&gt;</span>

<span class="x">    </span><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">begin</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;panel panel-default&quot;&gt;</span>
<span class="x">      &lt;div class=&quot;panel-body&quot;&gt;</span>
<span class="x">        &lt;h3&gt;Employee&lt;/h3&gt;</span>
<span class="x">        &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">          &lt;div class=&quot;col-md-2&quot;&gt;</span>
<span class="x">              </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;/div&gt;</span>
<span class="x">          &lt;div class=&quot;col-md-5&quot;&gt;</span>
<span class="x">            </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;/div&gt;</span>
<span class="x">          &lt;div class=&quot;col-md-5&quot;&gt;</span>
<span class="x">            </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">          &lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;    </span>
<span class="x">      &lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">  &lt;div class=&quot;panel panel-default&quot;&gt;</span>
<span class="x">    &lt;div class=&quot;panel-body&quot;&gt;</span>
<span class="x">        &lt;h3&gt;User&lt;/h3&gt;</span>
<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$modelUser</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$modelUser</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">        </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">submitButton</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="s1">&#39;Create&#39;</span> <span class="o">:</span> <span class="s1">&#39;Update&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="s1">&#39;btn btn-success&#39;</span> <span class="o">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    </span><span class="cp">&lt;?php</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">end</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;/div&gt;</span>
</code></pre></div>
<p>เมื่อทดสอบเรียกไปที่หน้า <code>index.php?r=m-emp/create</code> ก็จะพบหน้าตาดังนี้</p>

<p><img src="/img/multiple-model-form.png" alt=""></p>

<p>ทดลอง create ดู</p>

<h2 id="ปรับปรุง-actionupdate-ใน-mempcontroller-php">ปรับปรุง actionUpdate() ใน MEmpController.php</h2>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">actionUpdate</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findModel</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="nv">$modelUser</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findModelUser</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">user_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span>
    <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
    <span class="nv">$modelUser</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
    <span class="nx">Model</span><span class="o">::</span><span class="na">validateMultiple</span><span class="p">([</span><span class="nv">$model</span><span class="p">,</span><span class="nv">$modelUser</span><span class="p">])</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$modelUser</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">()){</span>
          <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">([</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">[</span>
          <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
          <span class="s1">&#39;modelUser&#39;</span><span class="o">=&gt;</span><span class="nv">$modelUser</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">findModelUser</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$model</span> <span class="o">=</span> <span class="nx">MUser</span><span class="o">::</span><span class="na">findOne</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$model</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundHttpException</span><span class="p">(</span><span class="s1">&#39;The requested page does not exist.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ฟังก์ชัน update จะแตกต่างจาก create เล็กน้อยตรงที่ดึงข้อมูลมาก่อนเพื่อ update ซึ่งปกติหากเรา gii crud จะมี findModel() ซึ่งเป็นของ MEmp เพราะฉะนั้นเราจึงต้องสร้าง <code>findModelUser()</code> ขึ้นมาเพิ่มเติมเพื่อดึงข้อมูลส่วนของ user</p>

<p><img src="/img/multiple-model-form-update.png" alt=""></p>

<p>ทดลอง create,update ข้อมูลดู</p>

<blockquote>
<p>ในการทำ one form multiple model ส่วนที่สำคัญที่สุดจะมีเพียงส่วน Model::multipleValidate() เท่านั้น</p>
</blockquote>

<h2 id="แก้ไข-models-memp-php">แก้ไข models/MEmp.php</h2>

<p>เพิ่มการ validate required เข้าไป และสร้าง relation เชื่อกับ model MUser เพิ่มคำอธิบายฟิวด์ในส่วน attributeLabels()</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;required&#39;</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="s1">&#39;integer&#39;</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">],</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span> <span class="o">=&gt;</span> <span class="mi">150</span><span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">attributeLabels</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Title&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surname&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Surname&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;User ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;รหัสผู้ใช้งาน&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fullname&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ชื่อ-นามสกุล&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getUser</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">MUser</span><span class="o">::</span><span class="na">className</span><span class="p">(),[</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;user_id&#39;</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getFullname</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">surname</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getUsername</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>แต่ละตัวมีหน้าที่ดังนี้</p>

<ul>
<li><code>getUser()</code> เป็นฟังก์ชันที่เอาไว้เชื่อมกับตาราง m_user</li>
<li><code>getFullname()</code> แสดงคำนำหน้าชื่อ, ชื่อ, นามสกุล</li>
<li><code>getUsername()</code> แสดงค่า username ของตาราง m_user ซึ่งเรียกผ่านตัว relation ที่ชื่อ <code>getUser</code> ตัวอย่างการเรียก ฟังก์ชัน เช่น <code>$model-&gt;fullnam</code></li>
</ul>

<p>โดยเราเตรียมฟังก์ชันเหล่านี้ไว้เพื่อใช้ในตอนแสดงผลที่ gridview หรือ DetailView หรือที่อื่นๆ ก็ได้</p>

<h2 id="แก้ไข-models-muser-php">แก้ไข models/MUser.php</h2>

<p>เพิ่มเฉพาะในส่วนฟังก์ชัน rules()</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="s1">&#39;required&#39;</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;integer&#39;</span><span class="p">],</span>
        <span class="p">[[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span> <span class="o">=&gt;</span> <span class="mi">150</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="เพิ่มการค้นหาและจัดเรียงข้อมูล-filter-amp-sort">เพิ่มการค้นหาและจัดเรียงข้อมูล ( Filter &amp; Sort  )</h1>

<p>เราจะเพิ่มเติมส่วนค้นหาและการจัดเรียงข้อมูลในส่วนของหัวคอลัมน์</p>

<h2 id="แก้ไข-models-mempsearch-php">แก้ไข models/MEmpSearch.php</h2>

<p>ประกาศตัวแปรเพิ่มเติม เพื่อให้สามารถเรียกใช้งานใน model ได้เพราะ 2 ฟิวด์นี้ไม่มีอยู่จริงใน table m_emp</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    public $fullname;
    public $username;
</code></pre></div>
<p>และอย่าลืมกำหนด validate ใน rule เพื่อให้ model สามารถใช้งาน 2 ฟิวด์นี้ได้</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">public function rules()
{
    return [
        [[&#39;id&#39;, &#39;user_id&#39;], &#39;integer&#39;],
        [[&#39;title&#39;, &#39;name&#39;, &#39;surname&#39;,&#39;fullname&#39;,&#39;username&#39;], &#39;safe&#39;],
    ];
}
</code></pre></div>
<p>เราจะเพิ่มส่วนการจัดเรียงข้อมูลเข้าไป มี fullname,username ดังนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$dataProvider-&gt;sort-&gt;attributes[&#39;fullname&#39;]=[</span>
<span class="x">  &#39;asc&#39;=&gt;[&#39;name&#39;=&gt;SORT_ASC,&#39;surname&#39;=&gt;SORT_DESC],</span>
<span class="x">  &#39;desc&#39;=&gt;[&#39;name&#39;=&gt;SORT_DESC,&#39;surname&#39;=&gt;SORT_DESC],</span>
<span class="x">];</span>
<span class="x">$dataProvider-&gt;sort-&gt;attributes[&#39;username&#39;]=[</span>
<span class="x">  &#39;asc&#39;=&gt;[&#39;m_user.username&#39;=&gt;SORT_ASC],</span>
<span class="x">  &#39;desc&#39;=&gt;[&#39;m_user.username&#39;=&gt;SORT_DESC],</span>
<span class="x">];</span>
</code></pre></div>
<p>ส่วนการค้นหาเพิ่ม fullname</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x"> $query-&gt;andWhere(&#39;name like &quot;%&#39;.$this-&gt;fullname.&#39;%&quot; or surname like &quot;%&#39;.$this-&gt;fullname.&#39;%&quot; &#39;);</span>
</code></pre></div>
<p>โค้ดทั้งหมด</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">backend\models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Yii</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\base\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\data\ActiveDataProvider</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">backend\models\MEmp</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * MEmpSearch represents the model behind the search form about `backend\models\MEmp`.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">MEmpSearch</span> <span class="k">extends</span> <span class="nx">MEmp</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$fullname</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @inheritdoc</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="s1">&#39;integer&#39;</span><span class="p">],</span>
            <span class="p">[[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;surname&#39;</span><span class="p">,</span><span class="s1">&#39;fullname&#39;</span><span class="p">,</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="s1">&#39;safe&#39;</span><span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @inheritdoc</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">scenarios</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// bypass scenarios() implementation in the parent class</span>
        <span class="k">return</span> <span class="nx">Model</span><span class="o">::</span><span class="na">scenarios</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Creates data provider instance with search query applied</span>
<span class="sd">     *</span>
<span class="sd">     * @param array $params</span>
<span class="sd">     *</span>
<span class="sd">     * @return ActiveDataProvider</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">search</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nx">MEmp</span><span class="o">::</span><span class="na">find</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">joinWith</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">);</span>

        <span class="nv">$dataProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveDataProvider</span><span class="p">([</span>
            <span class="s1">&#39;query&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="nv">$dataProvider</span><span class="o">-&gt;</span><span class="na">sort</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span>
          <span class="s1">&#39;asc&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_ASC</span><span class="p">,</span><span class="s1">&#39;surname&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_DESC</span><span class="p">],</span>
          <span class="s1">&#39;desc&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_DESC</span><span class="p">,</span><span class="s1">&#39;surname&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_DESC</span><span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$dataProvider</span><span class="o">-&gt;</span><span class="na">sort</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span>
          <span class="s1">&#39;asc&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;m_user.username&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_ASC</span><span class="p">],</span>
          <span class="s1">&#39;desc&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;m_user.username&#39;</span><span class="o">=&gt;</span><span class="nx">SORT_DESC</span><span class="p">],</span>
        <span class="p">];</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// uncomment the following line if you do not want to return any records when validation fails</span>
            <span class="c1">// $query-&gt;where(&#39;0=1&#39;);</span>
            <span class="k">return</span> <span class="nv">$dataProvider</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;name like &quot;%&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fullname</span><span class="o">.</span><span class="s1">&#39;%&quot; or surname like &quot;%&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fullname</span><span class="o">.</span><span class="s1">&#39;%&quot; &#39;</span><span class="p">);</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">andFilterWhere</span><span class="p">([</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user_id</span><span class="p">,</span>
            <span class="s1">&#39;m_user.username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
        <span class="p">]);</span>


        <span class="c1">// $query-&gt;andFilterWhere([&#39;like&#39;, &#39;title&#39;, $this-&gt;title])</span>
        <span class="c1">//     -&gt;andFilterWhere([&#39;like&#39;, &#39;name&#39;, $this-&gt;name])</span>
        <span class="c1">//     -&gt;andFilterWhere([&#39;like&#39;, &#39;surname&#39;, $this-&gt;surname]);</span>

        <span class="k">return</span> <span class="nv">$dataProvider</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="แก้ไข-view-m-emp-index-php">แก้ไข view/m-emp/index.php</h2>

<p>เราจะปรับปรุงส่วนค้นหาใน GridView ขั้นตอนแรก เราจะเรียกใช้งาน fullname, username ที่เราได้สร้างไว้ที่ model MEmp</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">yii\helpers\Html</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\grid\GridView</span><span class="p">;</span>

<span class="cm">/* @var $this yii\web\View */</span>
<span class="cm">/* @var $searchModel backend\models\MEmpSearch */</span>
<span class="cm">/* @var $dataProvider yii\data\ActiveDataProvider */</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="s1">&#39;Memps&#39;</span><span class="p">;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">&#39;breadcrumbs&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;div class=&quot;panel panel-default&quot;&gt;</span>
<span class="x">  &lt;div class=&quot;panel-body&quot;&gt;</span>

<span class="x">    &lt;h1&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="x">    </span><span class="cp">&lt;?php</span> <span class="c1">// echo $this-&gt;render(&#39;_search&#39;, [&#39;model&#39; =&gt; $searchModel]); ?&gt;</span>

    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
        <span class="o">&lt;?=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">a</span><span class="p">(</span><span class="s1">&#39;Create Memp&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;create&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;btn btn-success&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/p&gt;</span>

<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">GridView</span><span class="o">::</span><span class="na">widget</span><span class="p">([</span>
        <span class="s1">&#39;dataProvider&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dataProvider</span><span class="p">,</span>
        <span class="s1">&#39;filterModel&#39;</span> <span class="o">=&gt;</span> <span class="nv">$searchModel</span><span class="p">,</span>
        <span class="s1">&#39;columns&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yii\grid\SerialColumn&#39;</span><span class="p">],</span>
            <span class="c1">//&#39;id&#39;,</span>
            <span class="c1">// &#39;title&#39;,</span>
            <span class="c1">// &#39;name&#39;,</span>
            <span class="c1">// &#39;surname&#39;,</span>
            <span class="c1">// &#39;user_id&#39;,</span>
            <span class="s1">&#39;fullname&#39;</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">,</span>
            <span class="c1">// [</span>
            <span class="c1">//   &#39;attribute&#39;=&gt;&#39;user_id&#39;,</span>
            <span class="c1">//   &#39;value&#39;=&gt;&#39;user.username&#39;</span>
            <span class="c1">// ],</span>
            <span class="p">[</span>
              <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yii\grid\ActionColumn&#39;</span><span class="p">,</span>
              <span class="s1">&#39;options&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;width:120px;&#39;</span><span class="p">],</span>
              <span class="s1">&#39;buttonOptions&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;btn btn-default&#39;</span><span class="p">],</span>
              <span class="s1">&#39;template&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;&lt;div class=&quot;btn-group btn-group-sm text-center&quot; role=&quot;group&quot;&gt; {view} {update} {delete} &lt;/div&gt;&#39;</span>
           <span class="p">],</span>
        <span class="p">],</span>
    <span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</code></pre></div>
<p><img src="/img/multiple-model-index.png" alt=""></p>

<p>ทดลองเพิ่มลบแก้ไข จะพบว่าเราสามารถบันทึกข้อมูลได้แล้ว และบันทึกได้พร้อมๆ กัน</p>

<h1 id="ตรวจสอบความถูกต้องด้วย-transaction">ตรวจสอบความถูกต้องด้วย Transaction</h1>

<p>เพื่อทำให้ระบบของเราน่าเชื่อถือมากขึ้นควรตรวจสอบการบันทึกข้อมูลว่าสำเร็จทุกตารางหรือไม่โดยใช้ Transaction เข้ามาช่วยตรวจสอบกระบวนการทำงานว่าถูกต้องหรือไม่</p>

<p>รูปแบบโครงสร้าง</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">use yii\base\Model;

$transaction = Model::getDb()-&gt;beginTransaction();
try {
    // ...โค้ดส่วนที่เราต้องการดัก errror
   $transaction-&gt;commit();
} catch (\Exception $e) {
  // เมื่อมี error
   $transaction-&gt;rollBack();
}
</code></pre></div>
<p>เมื่อนำมารวมกับ actionCreate() จะได้ประมาณนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">public function actionCreate()</span>
<span class="x">    {</span>
<span class="x">        $modelEmp = new MEmp();</span>
<span class="x">        $modelUser = new MUser();</span>

<span class="x">        if($modelEmp-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp;</span>
<span class="x">           $modelUser-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp;</span>
<span class="x">           Model::validateMultiple([$modelEmp,$modelUser]))</span>
<span class="x">        {</span>
<span class="x">          $transaction = $modelUser::getDb()-&gt;beginTransaction();</span>
<span class="x">          try {</span>
<span class="x">            if($modelUser-&gt;save()){</span>
<span class="x">              $modelEmp-&gt;user_id = $modelUser-&gt;id;</span>
<span class="x">              $modelEmp-&gt;save();</span>
<span class="x">            }</span>
<span class="x">             $transaction-&gt;commit();</span>
<span class="x">          } catch (\Exception $e) {</span>
<span class="x">             $transaction-&gt;rollBack();</span>
<span class="x">          }</span>
<span class="x">            return $this-&gt;redirect([&#39;view&#39;, &#39;id&#39; =&gt; $modelEmp-&gt;id]);</span>
<span class="x">        } else {</span>
<span class="x">            return $this-&gt;render(&#39;create&#39;, [</span>
<span class="x">                &#39;model&#39; =&gt; $modelEmp,</span>
<span class="x">                &#39;modelUser&#39;=&gt;$modelUser</span>
<span class="x">            ]);</span>
<span class="x">        }</span>
<span class="x">    }</span>
</code></pre></div>
<h1 id="เพิ่ม-relation-เองโดยให้-model-จัดการ">เพิ่ม relation เองโดยให้ model จัดการ</h1>

<p>เป็นการใช้ความสามารถของ model คือ link() โดยที่เราไม่ต้องตั้งค่า id เพื่อให้มัน relation กัน เราสามารถเรียกใช้ link() แทนเดียวมันทำให้เอง</p>

<p>ปกติ</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">// ...</span>

<span class="x">if($modelUser-&gt;save()){</span>
<span class="x">  $modelEmp-&gt;user_id = $modelUser-&gt;id;</span>
<span class="x">  $modelEmp-&gt;save();</span>
<span class="x">}</span>

<span class="x">//...</span>
</code></pre></div>
<p>ใช้ความสามารถของ model โดยใช้ link() (<a href="http://www.yiiframework.com/doc-2.0/guide-db-active-record.html#saving-relations">ดูเพิ่มเติม</a>)</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">// ...</span>

<span class="x">  if($modelUser-&gt;save()){</span>
<span class="x">    $modelEmp-&gt;link(&#39;user&#39;,$modelUser); // easy way saving relations</span>
<span class="x">  }</span>

<span class="x">//...</span>
</code></pre></div>
<h1 id="สรุป">สรุป</h1>

<p>หลักการของการบันทึกทีละหลายๆ model ในฟอร์มเดียว มีแค่ 3 จุดคือ</p>

<ol>
<li>ต้องสร้าง object model ที่เราต้องการใช้แล้วส่งไปแสดงผลที่ฟอร์ม</li>
<li>ในตอนรับข้อมูลจาการ submit ต้องใช้ load() แยกกัน ส่วน validate ใช้ Model::multipleValidate() ร่วมกัน</li>
<li>บันทึกตารางหลักก่อนแล้วค่อยบันทึกตารางรองอื่นๆ ตามลำดับ</li>
</ol>

<p>คิดว่าคงทำให้เราพอเข้าใจหลักการทำงานเบื้องต้นและสามารถนำไปประยุกต์ใช้ในงานแบบต่างๆ ได้ นะครับ ^ ^</p>

<p>ตัวอย่าง SourceCode</p>

<ul>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/blob/master/backend/controllers/MEmpController.php">controller</a></li>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/blob/master/backend/models/MEmp.php">model</a></li>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/blob/master/backend/models/MEmpSearch.php">modelSearch</a></li>
<li><a href="https://github.com/dixonsatit/yii2-workshop-rbac-db-02/tree/master/backend/views/m-emp">view</a></li>
</ul>

<p>@dixonsatit</p>
</section>
</article>

<!-- Post navigation -->


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'dixonsatit';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
<script src="/js/main.js"></script>


<footer class="site-footer">

	<h6 style="font-weight:normal;">เครือข่ายพันธมิตรของเรา <small></small></h6>
	<a href="http://cloud-tutorial.com" target="_blank">
		<img src="http://cloud-tutorial.com/wp-content/uploads/2015/04/new-logo-sm.png" alt="cloud-tutorial.com" />
	</a>
	<hr>
	<p class="text"><a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/"><img alt="สัญญาอนุญาตของครีเอทีฟคอมมอนส์" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/th/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Yii2 Learning</span> โดย <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.dimpled.me" property="cc:attributionName" rel="cc:attributionURL">Sathit Seethaphon</a> บทความต่างๆ ในเว็บไซต์ อนุญาตให้นำไปเผยแพร่ได้ โดยต้องอ้างอิงที่มาและไม่ใช้เพื่อการค้า <br>ตาม<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/" > สัญญาอนุญาตของครีเอทีฟคอมมอนส์แบบ แสดงที่มา-ไม่ใช้เพื่อการค้า 3.0 ประเทศไทย</a>.<br> Powered by <a href="http://jekyllrb.com">Jekyll</a> with <a href="https://rohanchandra.github.io/project/type/">Type Theme</a>
</p>
</footer>


  </body>
</html>

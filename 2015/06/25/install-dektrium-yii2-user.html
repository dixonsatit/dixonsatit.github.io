<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>การติดตั้งและใช้งาน dektrium/yii2-user | DixonSatit</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/jekyll-github.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://dixonsatit.github.io/2015/06/25/install-dektrium-yii2-user.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="DixonSatit" href="http://dixonsatit.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-63817549-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7037e0cdf96cd3d4ad39b6c32ca29bd7?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">DixonSatit</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			<li>
				<a class="page-link" href="/yii2-learning/">
					Yii2 Learning
				</a>
			</li>
			
			
			
			<li>
				<a class="page-link" href="/yii2-tip-tricks.html">
					Yii2 Trip & Tricks
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			


<li>
	<a href="mailto:dixonsatit@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>









<li>
	<a href="https://www.facebook.com/yii2Learning" title="Follow on Facebook">
		<i class="fa fa-fw fa-facebook"></i>
	</a>
</li>





<li>
	<a href="https://github.com/dixonsatit" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/dixonsatit" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">การติดตั้งและใช้งาน dektrium/yii2-user</h1>
    <p class="meta">
    June 25, 2015
    
    </p>
  </header>
  <section class="post-content"><p><img src="/img/user-index.png" alt=""></p>

<p>Yii2 มี extension user อยู่หลายตัวเหมือนกัน แต่ที่ผมชอบและคิดว่าต่อเติมได้ง่ายที่สุด คือ <a href="https://github.com/dektrium/yii2-user">dektrium/yii2-user</a>  เพราะสามารถ custom layout ได้เอง override พวก controller,model ได้ และตัวจัดการ user ค่อยข้างเข้าใจง่าย</p>

<p>โดยขั้นตอนการติดตั้งมีดังนี้</p>

<ul>
<li>ติดตั้งผ่าน composer</li>
<li>ตั้งค่า Config<br></li>
<li>นำเข้าฐานข้อมูล</li>
<li>ตั้งค่าเมนู</li>
<li>ลงทะเบียน User เพื่อเข้าใช้งาน</li>
<li>login</li>
</ul>

<h2 id="การติดตั้ง">การติดตั้ง</h2>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">composer require &quot;dektrium/yii2-user:0.9.*@dev&quot;</span>
</code></pre></div>
<h2 id="ตั้งค่า">ตั้งค่า</h2>

<p>เปิดใช้งาน module user และ components user</p>

<ul>
<li>basic แก้ไขไฟล์ที่  <code>config/web.php</code></li>
<li>advance <code>frontend/config/main.php</code></li>
<li>advance <code>backend/config/main.php</code></li>
</ul>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$params</span> <span class="o">=</span> <span class="k">require</span><span class="p">(</span><span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/params.php&#39;</span><span class="p">);</span>

<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
<span class="c1">//...</span>
<span class="s1">&#39;components&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
 <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="c1">//&#39;identityClass&#39; =&gt; &#39;app\models\User&#39;,</span>
            <span class="s1">&#39;identityClass&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;dektrium\user\models\User&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enableAutoLogin&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
 <span class="p">],</span>
 <span class="c1">// ...</span>
<span class="p">],</span>
<span class="s1">&#39;modules&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;dektrium\user\Module&#39;</span><span class="p">,</span>
        <span class="s1">&#39;enableUnconfirmedLogin&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
        <span class="s1">&#39;confirmWithin&#39;</span> <span class="o">=&gt;</span> <span class="mi">21600</span><span class="p">,</span>
        <span class="s1">&#39;cost&#39;</span> <span class="o">=&gt;</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s1">&#39;admins&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="c1">//...</span>
<span class="p">],</span>
</code></pre></div>
<blockquote>
<p>หากคุณเปิดใช้งาน PrettyUrl ให้เพิ่ม <code>rule</code> สำหรับการใช้งาน module ที่ config ด้วยครับ</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">&#39;&lt;module:\w+&gt;/&lt;controller:\w+&gt;/&lt;action:\w+&gt;&#39; =&gt; &#39;&lt;module&gt;/&lt;controller&gt;/&lt;action&gt;&#39;,
</code></pre></div>
<p>โค้ดเมื่อเพิ่มเข้าไป</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$params</span> <span class="o">=</span> <span class="k">require</span><span class="p">(</span><span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/params.php&#39;</span><span class="p">);</span>

<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
<span class="c1">//...</span>
     <span class="s1">&#39;urlManager&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
               <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yii\web\UrlManager&#39;</span><span class="p">,</span>
               <span class="c1">// Disable index.php</span>
               <span class="s1">&#39;showScriptName&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
               <span class="c1">// Disable r= routes</span>
               <span class="s1">&#39;enablePrettyUrl&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
               <span class="s1">&#39;rules&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                       <span class="s1">&#39;&lt;controller:\w+&gt;/&lt;id:\d+&gt;&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;controller&gt;/view&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;&lt;controller:\w+&gt;/&lt;action:\w+&gt;/&lt;id:\d+&gt;&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;controller&gt;/&lt;action&gt;&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;&lt;controller:\w+&gt;/&lt;action:\w+&gt;&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;controller&gt;/&lt;action&gt;&#39;</span><span class="p">,</span>
                       <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;yii\rest\UrlRule&#39;</span><span class="p">,</span> <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;except&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span> <span class="s1">&#39;pluralize&#39;</span><span class="o">=&gt;</span><span class="k">false</span><span class="p">],</span>
                       <span class="s1">&#39;&lt;module:\w+&gt;/&lt;controller:\w+&gt;/&lt;action:\w+&gt;&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;module&gt;/&lt;controller&gt;/&lt;action&gt;&#39;</span><span class="p">,</span>
               <span class="p">],</span>
    <span class="p">],</span>
<span class="c1">//...</span>
<span class="p">]</span>
</code></pre></div>
<h2 id="นำเข้าข้อมูลโดยใช้-migrate">นำเข้าข้อมูลโดยใช้ Migrate</h2>

<blockquote>
<p>หารใครที่รันคำสั่ง <code>yii migrate</code> ไปแล้วในตอนติดตั้ง advance ให้เราเปลี่ยนชื่อตาราง <code>user</code> เป็นชื่ออื่นก่อนนะครับ หรือคิดว่าไม่ได้ใช้แล้วก็สามารถลบออกได้เลย แล้วหลังจากนั้นค่อย install ตามคำสั่งด้านล่าง</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">php yii migrate/up --migrationPath=@vendor/dektrium/yii2-user/migrations
</code></pre></div>
<blockquote>
<p>หากรันคำสั่งแล้วพบ error</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">Exception &#39;yii\db\Exception&#39; with message &#39;SQLSTATE[HY000] [2002] Can&#39;t connect to local MySQL server through socket &#39;/Applications/MAMP/tmp/mysql/mysql.sock&#39; (2)&#39;
</code></pre></div>
<p>ให้ลองเปลี่ยนการตั้งค่าฐานข้อมูล จาก <code>localhost</code> เป็น <code>127.0.0.1</code> หรือเป็น ip database ของคุณ</p>

<p>หากไม่มีปัญหาเราจะพบกับหน้าจอยืนยันการสร้างตารางด้านล่าง</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Yii Migration Tool (based on Yii v2.0.4)

Total 7 new migrations to be applied:
    m140209_132017_init
    m140403_174025_create_account_table
    m140504_113157_update_tables
    m140504_130429_create_token_table
    m140830_171933_fix_ip_field
    m140830_172703_change_account_table_name
    m141222_110026_update_ip_field

Apply the above migrations? (yes|no) [no]:
</code></pre></div>
<p>ให้ทำการตอบ <code>yes</code> หลังจากนั้น yii-user จะสร้างตางรางให้เราสามารถตรวจสอบที่ฐานของคุณได้</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">*** applying m140209_132017_init
    &gt; create table  ... done (time: 0.056s)
    &gt; create unique index user_unique_username on  (username) ... done (time: 0.047s)
    &gt; create unique index user_unique_email on  (email) ... done (time: 0.035s)
    &gt; create unique index user_confirmation on  (id, confirmation_token) ... done (time: 0.066s)
    &gt; create unique index user_recovery on  (id, recovery_token) ... done (time: 0.033s)
    &gt; create table  ... done (time: 0.023s)
    &gt; add foreign key fk_user_profile:  (user_id) references  (id) ... done (time: 0.015s)
*** applied m140209_132017_init (time: 0.288s)

*** applying m140403_174025_create_account_table
    &gt; create table  ... done (time: 0.028s)
    &gt; create unique index account_unique on  (provider,client_id) ... done (time: 0.018s)
    &gt; add foreign key fk_user_account:  (user_id) references  (id) ... done (time: 0.023s)
*** applied m140403_174025_create_account_table (time: 0.072s)

*** applying m140504_113157_update_tables
    &gt; drop index user_confirmation ... done (time: 0.029s)
    &gt; drop index user_recovery ... done (time: 0.010s)
    &gt; drop column confirmation_token from table  ... done (time: 0.040s)
    &gt; drop column confirmation_sent_at from table  ... done (time: 0.054s)
    &gt; drop column recovery_token from table  ... done (time: 0.040s)
    &gt; drop column recovery_sent_at from table  ... done (time: 0.036s)
    &gt; drop column logged_in_from from table  ... done (time: 0.040s)
    &gt; drop column logged_in_at from table  ... done (time: 0.040s)
    &gt; rename column registered_from in table  to registration_ip ... done (time: 0.021s)
    &gt; add column flags integer NOT NULL DEFAULT 0 to table  ... done (time: 0.043s)
    &gt; rename column properties in table  to data ... done (time: 0.017s)
*** applied m140504_113157_update_tables (time: 0.373s)

*** applying m140504_130429_create_token_table
    &gt; create table  ... done (time: 0.027s)
    &gt; create unique index token_unique on  (user_id,code,type) ... done (time: 0.018s)
    &gt; add foreign key fk_user_token:  (user_id) references  (id) ... done (time: 0.051s)
*** applied m140504_130429_create_token_table (time: 0.098s)

*** applying m140830_171933_fix_ip_field
    &gt; alter column registration_ip in table  to bigint ... done (time: 0.033s)
*** applied m140830_171933_fix_ip_field (time: 0.038s)

*** applying m140830_172703_change_account_table_name
    &gt; rename table  to  ... done (time: 0.024s)
*** applied m140830_172703_change_account_table_name (time: 0.027s)

*** applying m141222_110026_update_ip_field
    &gt; alter column registration_ip in table  to string(45) ... done (time: 0.036s)
*** applied m141222_110026_update_ip_field (time: 0.041s)


Migrated up successfully.
</code></pre></div>
<p>จากนั้น yii-user จะสร้างตางรางให้เรา สามารถตรวจสอบที่ฐานของคุณได้</p>

<h2 id="การตั้งค่าเมนู">การตั้งค่าเมนู</h2>

<p>ให้ทำการเพิ่มเมนูสำหรับ login,logout และเมนูอื่นๆ ที่ <code>layout/main.php</code> ที่ <code>Nav::widget</code> ในส่วนของ items เพิ่มเติมเข้าไป</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">Yii::$app-&gt;user-&gt;isGuest ?</span>
<span class="x">[&#39;label&#39; =&gt; &#39;Sign in&#39;, &#39;url&#39; =&gt; [&#39;/user/security/login&#39;]] :</span>
<span class="x">[&#39;label&#39; =&gt; &#39;Account(&#39; . Yii::$app-&gt;user-&gt;identity-&gt;username . &#39;)&#39;, &#39;items&#39;=&gt;[</span>
<span class="x">    [&#39;label&#39; =&gt; &#39;Profile&#39;, &#39;url&#39; =&gt; [&#39;/user/settings/profile&#39;]],</span>
<span class="x">    [&#39;label&#39; =&gt; &#39;Account&#39;, &#39;url&#39; =&gt; [&#39;/user/settings/account&#39;]],</span>
<span class="x">    [&#39;label&#39; =&gt; &#39;Logout&#39;, &#39;url&#39; =&gt; [&#39;/user/security/logout&#39;],&#39;linkOptions&#39; =&gt; [&#39;data-method&#39; =&gt; &#39;post&#39;]],</span>
<span class="x">]],</span>
<span class="x">[&#39;label&#39; =&gt; &#39;Register&#39;, &#39;url&#39; =&gt; [&#39;/user/registration/register&#39;], &#39;visible&#39; =&gt; Yii::$app-&gt;user-&gt;isGuest],</span>
</code></pre></div>
<p>รายการเมนูอื่นๆ ที่สามารถใช้งานได้</p>

<ul>
<li><code>/user/registration/register</code> หน้าสมัครสมาชิก</li>
<li><code>/user/registration/resend</code>  หน้าส่งอีเมล์ยืนยันใหม่อีกรอบ หากไม่ได้รับ</li>
<li><code>/user/registration/confirm</code>  หน้า link เมื่อคลิก confirm อีเมล์เพื่อยันยันการสมัครสมาชิก (requires <em>id</em> and <em>token</em> query params)</li>
<li><code>/user/security/login</code>        หน้าล็อคอิน</li>
<li><code>/user/security/logout</code>       หน้าล็อกเอาท์ (available only via POST method)</li>
<li><code>/user/recovery/request</code>      หน้าจอกู้รหัสผ่าน โดยกรอกอีเมล์ที่เคยลงทะเบียนไว้</li>
<li><code>/user/recovery/reset</code>        หน้าจอเปลี่ยนรหัสผ่านหลังจากได้รับอีเมล์กู้รหัสผ่าน (requires <em>id</em> and <em>token</em> query params)</li>
<li><code>/user/settings/profile</code>      หน้าจอโปรไฟล์ user</li>
<li><code>/user/settings/account</code>      หน้าจอตั้งค่า  (email, username, password)</li>
<li><code>/user/settings/networks</code>     หน้าจอแสดงรายการ login ผ่าน social</li>
<li><code>/user/profile/show</code>         หน้าจอแสดงข้อมูลรายละเอียด user (requires <em>id</em> query param)</li>
<li><code>/user/admin/index</code>           หน้าจอจัดการข้อมูล user</li>
</ul>

<h2 id="การใช้งาน">การใช้งาน</h2>

<p>ให้ทำการ register ก่อน เพราะระบบจะไม่มีข้อมูล user มาให้เลย ต้อง register</p>

<blockquote>
<p>ในส่วนของ module user เราจะทำการตั้งค่า <code>&#39;enableUnconfirmedLogin&#39; =&gt; false</code> เพื่อให้ไม่ต้องยืนยันอีเมล์หลังสมัครสมาชิก เพื่อลงทะเบียนในครั้งแรกก่อน</p>
</blockquote>

<p><img src="/img/user-register.png" alt=""></p>

<p>ลงทะเบียนเสร็จให้ทำการ login</p>

<p><img src="/img/user-login.png" alt=""></p>

<p>เมื่อ login เสร็จจะพบเมนู</p>

<p><img src="/img/user-menus.png" alt=""></p>

<p>หน้าจอ โปรไฟล์</p>

<p><img src="/img/user-profile.png" alt=""></p>

<p>หน้าจอ account</p>

<p><img src="/img/user-account.png" alt=""></p>

<p>น่าจะพอช่วยให้การติดตั้ง yii-user ง่ายขึ้นนะครับ ^ ^</p>
</section>
</article>

<!-- Post navigation -->


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'dixonsatit';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    <script src="/js/main.js"></script>


<footer class="site-footer">
	<p class="text"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Yii2 Learning</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.dimpled.me" property="cc:attributionName" rel="cc:attributionURL">Satit Seethaphon</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.<br />Based on a work at <a xmlns:dct="http://purl.org/dc/terms/" href="http://dixonsatit.github.io" rel="dct:source">http://dixonsatit.github.io</a><br> Powered by <a href="http://jekyllrb.com">Jekyll</a> with <a href="https://rohanchandra.github.io/project/type/">Type Theme</a>
</p>
</footer>


  </body>
</html>

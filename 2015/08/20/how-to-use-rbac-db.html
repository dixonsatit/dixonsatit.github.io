<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>RBAC คืออะไร? พร้อมสอนวิธีใช้ RBAC DB | Yii 2 Learning</title>
	<meta name="description" content="RBAC คืออะไร? พร้อมสอนวิธีใช้ RBAC DB | ในการพัฒนาระบบ เราจำต้องมีการควบคุมการเข้าใช้งานในส่วนต่างๆ ถ้าหากระบบของเรามีเพียงแค่ login,logout นั้นคงไม่พอครับ เพราะในการใช้งานปกติ ผู้ใช้งานแต่ละคนอาจจ... Yii2, Yii Framework, Extension, Howto,tutorial">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/jekyll-github.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://dixonsatit.github.io/2015/08/20/how-to-use-rbac-db.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Yii 2 Learning" href="http://dixonsatit.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-63817549-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7037e0cdf96cd3d4ad39b6c32ca29bd7?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Yii 2 Learning</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			<li>
				<a class="page-link" href="/yii2-learning/">
					Table Of Contents
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			


<li>
	<a href="mailto:dixonsatit@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>









<li>
	<a href="https://www.facebook.com/yii2Learning" title="Follow on Facebook">
		<i class="fa fa-fw fa-facebook"></i>
	</a>
</li>





<li>
	<a href="https://github.com/dixonsatit" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/dixonsatit" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">RBAC คืออะไร? พร้อมสอนวิธีใช้ RBAC DB</h1>
    <p class="meta">
    August 20, 2015
    
    </p>
  </header>
  <section class="post-content"><p>ในการพัฒนาระบบ เราจำต้องมีการควบคุมการเข้าใช้งานในส่วนต่างๆ ถ้าหากระบบของเรามีเพียงแค่ login,logout นั้นคงไม่พอครับ เพราะในการใช้งานปกติ ผู้ใช้งานแต่ละคนอาจจะมีสิทธิ์ในการเข้าใช้งานที่แตกต่างกัน อย่างน้อยก็เพื่อเป็นการปกป้องข้อมูลหรือการใช้งานในแต่ละส่วนให้ถูกต้องเหมาะสม  ถ้าหากระบบที่เราได้พัฒนาขึ้นแล้ว แต่ยังไม่มีการจัดการ RBAC ผมคิดว่าคุณควรต้องคิดใหม่..เพราะตรงนี้  Yii2 ได้เตรียมไว้ให้เราครบ พร้อมเสริฟ รอเพียงแค่กดน้ำร้อน ปรุงรสตามใจชอบ เท่านั้นเอง ดี้ดี ^ ^</p>

<p>เนื้อหาในเรื่องนี้ผมจะอธิบายตั้งแต่การออกแบบ RBAC ไปจนถึงตัวอย่างการใช้งานกับโปรเจ็คง่ายๆ เพื่อให้เราสามารถออกแบบและใช้งาน RBAC กับ Application ที่เราพัฒนาได้อย่างเหมาะสม</p>

<h1 id="เนื้อหามีอะไรบ้าง">เนื้อหามีอะไรบ้าง</h1>

<ul>
<li><a href="#rbac-%E0%B8%84%E0%B8%B7%E0%B8%AD%E0%B8%AD%E0%B8%B0%E0%B9%84%E0%B8%A3">RBAC คืออะไร?</a></li>
<li>ลองออกแบบ RBAC</li>
<li>สร้างโปรเจ็คเพื่อใช้งาน RBAC</li>
<li>การติดตั้งและสร้าง RBAC</li>
<li>รู้จักกับ Access Control Filter</li>
<li>การกำหนดค่าและเรียกใช้งาน RBAC ใน Controller</li>
<li>สร้าง Rule เพื่อตรวจสอบผู้ใช้งาน</li>
<li>ปรับปรุงระบบ Registration เพื่อใส่ค่า default Role</li>
<li>การสร้างระบบจัดการผู้ใช้งานเพื่อมอบสิทธิ์ให้กับผู้ใช้งาน</li>
</ul>

<h1 id="rbac-คืออะไร">RBAC คืออะไร?</h1>

<p>RBAC คือ การจัดการสิทธิ์การเข้าใช้งานหรือที่เรียกว่า Role Based Access Control (RBAC) ซึ่งเป็นการควบคุมการเข้าใช้งานในส่วนต่างๆ ของ application ที่เราได้สร้างขึ้น โดยเมื่อมีการเรียกใช้งานในแต่ละส่วน RBAC จะคอยเช็คผู้ใช้งานแต่ละคนว่า มีสิทธิ์ที่จะเข้าใช้งานในส่วนนี้หรือไม่ หากมีก็จะยอมให้เข้าใช้งาน แต่ถ้าหากไม่มีก็จะทำการแสดง error forbidden ออกไป เพื่อให้ผู้ใช้งานทราบว่าไม่สามารถเข้าใช้งานในส่วนนี้ได้</p>

<p>โดยปกติแล้ว ผู้ใช้งานแต่ละคนจะมีสิทธ์ในการเข้าใช้งานแตกต่างกัน เพราะฉะนั้นเราจึงจำเป็นต้องแยก role ออกเป็นกลุ่มๆ โดยให้แต่ละกลุ่มมีสิทธิ์ในการเข้าใช้งานที่ไม่เหมือนกัน เมื่อผู้ใช้งานได้รับ role ใหนก็จะสามารถเข้าใช้งานได้ตามสิทธิ์ที่ role นั้นมี ทำให้เราสามารถควบคุมการเข้าใช้งานในส่วนต่างๆ ได้อย่างเหมาะสมและยืดยุ่น</p>

<p><img src="/img/rbac-flow.jpg" alt=""></p>

<p>ส่วนประกอบหลักๆ ของ rbac ใน yii ที่เราสามารถสร้างได้จะประกอบไปด้วย 3 ส่วนคือ</p>

<ul>
<li>Permission ก็เปรียบเสมือนใบอนุญาติที่บอกว่าเราสามารถทำอะไรได้บ้าง</li>
<li>Role เป็นกลุ่มของ Permission หลายๆ ตัว ที่เกี่ยวข้องกัน รวมตัวกัน เพื่อให้สามารถเรียกใช้งานได้สะดวก ไม่ต้องเรียกใช้งานที่ Permission ทีละอัน</li>
<li>Rule จะคล้ายๆ กับ Role แต่เป็น Role ที่เราสร้างขึ้นเป็นไฟล์ class เพื่อใช้ในการตรวจสอบค่าบางอย่าง</li>
</ul>

<p>ถ้าดูจากภาพด้านบนจะเห็นว่ามี Role ทั้งหมด 5 ตัว ซึ่งแต่ละตัวมีความสามารถที่แตกต่างกัน ภายใน Role แต่ละตัวอาจมี Role หรือ Permission อยู่ภายใต้สังกัดได้ ส่วน Permission จะไม่อยู่ภายใต้ Role ก็ได้ แต่ในความเป็นจริง เมื่อใช้งานมันอาจจะไม่สะดวก เพราะหากมี Permission ทั้งหมด 10 ตัวแล้วเราต้องการใช้ User ใช้งานได้เราต้อง add Permission ทั้งหมด 10 ตัวให้ user คนนั้น แต่ถ้าหากเราย้ายให้มันสังกัดที่ Role แล้วเวลาให้สิทธิ์เราก็ให้ Role แค่ตัวเดียว ผู้ใช้งานก็จะได้สิทธิ์การเข้าใช้งานทั้ง 10 ตัว ซึ่งจะสะดวกและยืดยุ่นกว่ามากๆ</p>

<p>เพื่อให้สามารถเข้าใจได้ง่ายๆ ผมจะยกตัวอย่าง โดยใช้ Role ที่กำหนดขึ้นมาใหม่ 3 ตัว คือ</p>

<ul>
<li>Blog การใช้งาน blog ทั้งหมดเช่น create,update,delete</li>
<li>Report การดูรายงานต่างๆ</li>
<li>Export การ export ข้อมูลในรูปแบบต่างๆ</li>
</ul>

<p><strong>ตัวอย่างที่ 1</strong></p>

<p><img src="/img/rbac-03-1.jpg" alt=""></p>

<p>เมื่อเราดูตามภาพแล้วจะเห็นว่า มีการมอบ role <code>Blog</code> ให้กับ User เมื่อ User ได้รับก็จะสามารถเข้าใช้งานในส่วนของ blog ได้แต่ในส่วนของ role <code>Report</code> และ <code>Export</code> จะไม่สามารถเข้าใช้งานได้เพราะ user ไม่ได้รับ role นั้น</p>

<p><strong>ตัวอย่างที่ 2</strong></p>

<p><img src="/img/rbac-03-2.jpg" alt=""></p>

<p>User ได้รับมอบ Role <code>Report</code> และ <code>Export</code> เพราะฉะนั้นก็จะเข้าใช้งาน report,export ได้ ยกเว้น blog เพราไม่ได้รับ role <code>Blog</code> มา</p>

<p><strong>ตัวอย่างที่ 3</strong></p>

<p><img src="/img/rbac-03-3.jpg" alt=""></p>

<p>สังเกตว่า User จะได้รับมอบในส่วนของ Role <code>Blog</code> เพียงอย่างเดียว แต่ User สามารถเข้าใช้งานทั้ง <code>Blog</code> และ <code>report</code> ได้ เพราะว่า report ในอยู่ภายใต้ Role <code>Blog</code> เพราะฉะนั้นใครก็ตามที่ได้รับ role <code>Blog</code> ก็จะสามารถใช้งาน reprot ได้ด้วย</p>

<p><strong>ตัวอย่างที่ 4</strong></p>

<p><img src="/img/rbac-03-4.jpg" alt=""></p>

<p>User ได้รับมอบ role <code>Report</code> ก็จะสามารถเข้าใช้งาน report ได้เพียงอย่างเดียวแม้ว่า role <code>Report</code> จะอยู่ภายใต้ <code>Blog</code> ก็ตาม แต่ถ้าหามี role อะไรก็ตามอยู่ภายใต้ role <code>Report</code> มันก็จะสามารถเข้าใช้งานได้ตามไปด้วย</p>

<p><strong>ตัวอย่างที่ 5</strong></p>

<p><img src="/img/rbac-03-5.jpg" alt=""></p>

<p>ในตัวอย่างนี้เราแก้ปัญหาในเรื่องที่ต้องมอบ role ให้กับผู้ใช้งาน โดยปกติถ้าหากแต่ละ role ไม่ได้ขึ้นต่อกันแล้ว เราจะต้องทำการ assignment role ทั้ง 3 ตัวให้กับ user แต่ละคน คนละ 3 role มีกี่คนก็คูน 3 เข้าไปซึ่งมันจะเยอะมาก</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">+</span><span class="c1">-----------+---------+</span>
<span class="o">|</span> <span class="n">item_name</span> <span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Report</span>    <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Export</span>    <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Report</span>    <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Export</span>    <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Report</span>    <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Export</span>    <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+</span>
</code></pre></div>
<p>แต่ถ้าเราปรับใหม่โดยให้ role ที่เกี่ยวข้องกันจัดเป็นลำดับชั้นไว้ตามภาพด้านบน เช่น ตัวอย่างจะเรียงลำดับตามนี้ Blog-&gt;Report-&gt;Export โดยให้ <code>Blog</code> เป็น Role สูงสุด ถ้าหากอยากให้ผู้ใช้งานสามารถเข้าใช้งานได้ทั้งหมด 3 role ก็แค่มอบ role Blog ให้กับผู้ใช้งานหรือ User นั้นๆ เมื่อดูข้อมูล</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">+</span><span class="c1">-----------+---------+</span>
<span class="o">|</span> <span class="n">item_name</span> <span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Blog</span>      <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+</span>
</code></pre></div>
<p>ผู้ใช้งานหรือ User ก็จะสามารถเข้าใช้งานได้ทั้ง 3 ส่วนคือ Blog,Report,Export</p>

<blockquote>
<p>ตารางผมแค่ทำให้มองเห็นภาพว่าเวลาที่มันเก็บข้อมูลมันเก็บยังไง</p>
</blockquote>

<p><strong>ตัวอย่างที่ 6</strong></p>

<p><img src="/img/rbac-03-6.jpg" alt=""></p>

<p>ตัวอย่างนี้ได้เพิ่ม role <code>Admin</code> ขึ้นมาเพื่อเป็นตัวควบคุมสูงสุด เพื่อที่จะทำให้เราสามารถมอบ role ต่างๆ ได้อิสระมากขึ้น สังเกตุว่า <code>Admin</code> จะมี role ที่เอาไว้จัดการข้อมูลผู้ใช้งานคือ role <code>ManageUser</code> เพื่อให้ <code>Admin</code> สามารถจัดการข้อมูลผู้ใช้ได้ จึงให้ role <code>ManageUser</code> ไปอยู่ภายใต้ role <code>Admin</code></p>

<p><strong>ตัวอย่างที่ 7</strong></p>

<p><img src="/img/rbac-03-7.jpg" alt=""></p>

<p>ถ้าเรามอบ role <code>Blog</code> ให้กับ user แล้ว user ก็ใช้งานได้แค่ role <code>Blog,Report,Export</code></p>

<p><strong>ตัวอย่างที่ 8</strong></p>

<p><img src="/img/rbac-03-8.jpg" alt=""></p>

<p>ถ้าหาก user ได้รับมอบ role <code>ManageUser</code> แล้วก็จะสามารถใช้งานได้แค่ส่วนจัดการข้อมูลผู้ใช้งานเท่านั้น</p>

<p><strong>ตัวอย่างที่ 9</strong></p>

<p><img src="/img/rbac-03-9.jpg" alt=""></p>

<p>ถ้าหากต่อไปมีการเพิ่ม role ใหม่เข้ามาชื่อ <code>Export-csv</code> ใครก็ตามที่อยู่บน role Export-csv  ก็จะสามารถใช้งานได้ทันทีโดยไม่ต้องแก้ไขข้อมูลการ assignment ใหม่เลย อย่างเช่น ถ้าได้รับ role <code>Blog</code> ก็จะสามารถใช้งาน Blog-&gt;Report-&gt;Export-&gt;Export-csv ได้เลย เพราะ Export-csv อยู่ภายใต้ Blog อยู่แล้ว</p>

<p><strong>ตัวอย่างที่ 10</strong></p>

<p><img src="/img/rbac-03-10.jpg" alt=""></p>

<p>ถ้า User ได้รับ role <code>Blog</code> ก็จะสามารถใช้งาน Blog-&gt;Report-&gt;Export-&gt;Export-csv ได้เลย เพราะ Export-csv อยู่ภายใต้ Blog อยู่แล้ว</p>

<p>ตัวอย่างทั้งหมดคิดว่าคงพอทำให้เราเข้าใจและสามารถออกแบบ rbac ที่เหมาะสมกับงานของตัวเองได้ ต่อไปเราจะทำการลงมือสร้าง rbac จริงๆ เพื่อใช้งานกับ application ของเรา</p>

<h1 id="ลงมือสร้าง-rbac">ลงมือสร้าง RBAC</h1>

<p>หลักๆ ในการสร้าง RBAC นั้น เราจะต้องทำการวิเคราะห์ว่า application ของเรา มีการทำงานหลักๆ อะไรบ้าง ในแต่ละส่วนต้องทำอะไรบ้าง เพื่อให้สามารถสร้าง rbac ได้อย่างง่ายๆ ผมจะยกตัวอย่างการสร้างระบบ Blog ตามตัวอย่าง <a href="http://www.yiiframework.com/doc-2.0/guide-security-authorization.html">doc-2.0</a> ได้เขียนอธิบายไว้ เพราะเข้าใจง่าย</p>

<p>การออกแบบจะใช้ตัวอย่างการสร้าง Blog แบบง่ายๆ ไม่ซับซ้อนเพื่อให้เราสามารถทำความเข้าใจได้อย่างรวดเร็ว ก่อนอื่นเราจะต้องแบ่งกลุ่มผู้ใช้งานว่ามีอะไรบ้างหลักๆ แยกออกมา หลังจากนั้นให้เราเขียนความสามารถของระบบว่าทำอะไรได้บ้างหลักๆ ออกเป็นข้อๆ ดังนี้</p>

<h2 id="กลุ่มผู้ใช้งาน">กลุ่มผู้ใช้งาน</h2>

<p>ระบบแบ่งผู้ใช้งานเป็น 4 กลุ่มใหญ่ๆ คือ</p>

<ul>
<li>Author ผู้ใช้งานที่เขียนบทความ</li>
<li>Editor ผู้ตรวจสอบ</li>
<li>ManageUser จัดการข้อมูลผู้ใช้งาน</li>
<li>Admin ผู้ดูแลระบบ</li>
</ul>

<p>ซึ่งในส่วนนี้เราจะเรียกมันว่า Role</p>

<h2 id="สิทธิ์การเข้าใช้งาน">สิทธิ์การเข้าใช้งาน</h2>

<ul>
<li>สามารถ create บทความได้</li>
<li>สามารถ update บทความได้</li>
<li>สามารถ update บทความคนอื่นได้</li>
<li>สามารถ delete บทความคนอื่นได้</li>
<li>สามารถ จัดการข้อมูลผู้ใช้งาน</li>
</ul>

<p>เมื่อเราทำการวิเคราะห์และออกแบบระบบหลักๆ ได้แล้วเราจะต้องทำการให้สิทธิ์ แก่ Role หรือกลุ่มผู้ใช้งานที่เราได้ทำการออกแบบไว้ว่า กลุ่มใหนสามารถทำอะไรได้บ้างดังนี้</p>

<p><img src="/img/rbac-role.jpg" alt=""></p>

<ul>
<li><p>Author</p>

<ul>
<li>create บทความ</li>
<li>update บทความ</li>
</ul></li>
<li><p>Editor</p>

<ul>
<li>update บทความของ Author ได้</li>
<li>delete บทความของ Author ได้</li>
</ul></li>
<li><p>ManageUser</p>

<ul>
<li>สามารถจัดการข้อมูลผู้ใช้งานได้</li>
</ul></li>
<li><p>Admin</p>

<ul>
<li>เป็นผู้ดูแลระบบ</li>
</ul></li>
</ul>

<p>เมื่อเราออกแบบและเข้าใจโครงสร้างระบบโดยรวมแล้ว จะทำให้เราสามารถสร้าง RBAC ได้ง่าย และไม่สับสน</p>

<h2 id="เตรียม-project-ให้พร้อม">เตรียม project ให้พร้อม</h2>

<p>ก่อนอื่นเราจะต้องเตรียม project ให้พร้อม โดยตัวอย่างนี้เราจะใช้ Advanced Project Template เพราะมีระบบ login มาให้อยู่แล้ว ให้ทำการสร้าง Advanced Project Template ดูวิธีการสร้าง<a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">ได้ที่นี่ </a> หลังจากติดตั้งเสร็จแล้วให้ทำตามขั้นตอนต่อไปนี้</p>

<ul>
<li>php yii/init</li>
<li>สร้างฐานข้อมูลไว้ ชื่อ yii2-workshop-rbac-db</li>
<li>ทำการ config ฐานข้อมูลที่ common/config/main-local.php ใส่ชื่อฐานข้อมูลและ username &amp; password เปลี่ยน localhost เป็น 127.0.0.1 ให้ถูกต้อง</li>
<li>ทำการนำเข้าฐานข้อมูล user โดยใช้คำสั่ง <code>php yii migrate</code></li>
<li><p>ลงทะเบียนผู้ใช้งาน โดยกำหนด user,password,email เพื่อใช้สำหรับเข้าทดสอบการใช้งาน rbac ที่เราจะสร้างขึ้น มีข้อมูลดังนี้</p>

<ul>
<li>user-a, <a href="mailto:user-a@gmail.com">user-a@gmail.com</a>, 123456</li>
<li>user-b, <a href="mailto:user-b@gmail.com">user-b@gmail.com</a>, 123456</li>
<li>user-c, <a href="mailto:user-c@gmail.com">user-c@gmail.com</a>, 123456</li>
<li>user-d, <a href="mailto:user-d@gmail.com">user-d@gmail.com</a>, 123456</li>
</ul></li>
</ul>

<p>ไปที่ frontend และทำการสมัครสมาชิกที่หน้า <code>site/signup</code> ด้วย username,email, password ที่กำหนดให้ในด้านบน</p>

<p><img src="/img/rbac-db-register.png" alt=""></p>

<p>หลังจากลงทะเบียนเสร็จเรียบร้อยให้ทำการทดสอบ login ว่าสามารถใช้งานได้จริงหรือไม่ เมื่อสมัครสมาชิกเสร็จ ให้เราทำการตรวจสอบข้อมูลที่ตาราง user จะพบรายการดังนี้</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">username</span><span class="p">,</span><span class="n">email</span> <span class="k">from</span> <span class="k">user</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------+------------------+</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">email</span>            <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+------------------+</span>
<span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">a</span>   <span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">a</span><span class="o">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">b</span>   <span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">b</span><span class="o">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="k">c</span>   <span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="k">c</span><span class="o">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">d</span>   <span class="o">|</span> <span class="k">user</span><span class="o">-</span><span class="n">d</span><span class="o">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+------------------+</span>
<span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<h2 id="เปิดการใช้งาน-rbac">เปิดการใช้งาน RBAC</h2>

<p>Yii 2 มี RBAC ให้เลือกใช้งาน 2 แบบ คือ <code>yii\rbac\PhpManager</code> and <code>yii\rbac\DbManager</code> ทั้ง 2 ตัวนี้การทำงานหลักๆ ไม่ต่างกัน ต่างกันที่การเก็บข้อมูลเท่านั้นแล้วแต่จะเลือกใช้งาน ตามตัวอย่างวันนี้จะเลือกใช้งาน <code>yii\rbac\DbManager</code> เพราะสามารถจัดการได้ง่าย สามารถดูข้อมูลได้ที่ database ของเรา</p>

<h3 id="เปิดใช้งาน-yii-rbac-dbmanager">เปิดใช้งาน yii\rbac\DbManager</h3>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">return [</span>
<span class="x">    // ...</span>
<span class="x">    &#39;components&#39; =&gt; [</span>
<span class="x">        &#39;authManager&#39; =&gt; [</span>
<span class="x">            &#39;class&#39; =&gt; &#39;yii\rbac\DbManager&#39;,</span>
<span class="x">        ],</span>
<span class="x">        // ...</span>
<span class="x">    ],</span>
<span class="x">];</span>
</code></pre></div>
<p>เนื่องจาก  <code>DbManager</code> เก็บข้อมูลที่ db ดังนั้นเราจะต้องนำเข้าโครงสร้างตารางที่ yii เตรียมไว้ให้แล้วโดยใช้ migration ให้เปิด command line แล้วเข้าไปที่  root โปรเจ็คของเราจากนั้นทำการรันคำสั่ง</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">php yii migrate --migrationPath=@yii/rbac/migrations
</code></pre></div>
<p>ก็จะพบข้อความ</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Yii Migration Tool (based on Yii v2.0.6)

Total 1 new migration to be applied:
m140506_102106_rbac_init

Apply the above migration? (yes|no) [no]:yes
*** applying m140506_102106_rbac_init
  &gt; create table  ... done (time: 0.050s)
  &gt; create table  ... done (time: 0.019s)
  &gt; create index idx-auth_item-type on  (type) ... done (time: 0.025s)
  &gt; create table  ... done (time: 0.027s)
  &gt; create table  ... done (time: 0.024s)
*** applied m140506_102106_rbac_init (time: 0.174s)


Migrated up successfully.
</code></pre></div>
<p>และทำการเช็คดูใน​ฐานข้อมูลของเราจะพบว่ามีตารางใหม่ขึ้นมา 4 ตาราง ดังนี้</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">tables</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------------------------+</span>
<span class="o">|</span> <span class="n">Tables_in_yii2</span><span class="o">-</span><span class="n">workshop</span><span class="o">-</span><span class="n">rbac</span><span class="o">-</span><span class="n">db</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------------------------+</span>
<span class="o">|</span> <span class="n">auth_assignment</span>                 <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_item</span>                       <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_item_child</span>                 <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_rule</span>                       <span class="o">|</span>
<span class="o">|</span> <span class="n">migration</span>                       <span class="o">|</span>
<span class="o">|</span> <span class="k">user</span>                            <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------------------------+</span>
<span class="mi">6</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>ตารางของ RBAC จะมี prefix นำหน้าว่า <code>auth_</code> เสมอ</p>

<blockquote>
<p>ถ้าหากพบ error อาจต้องตรวจสอบคอนฟิกในส่วนฐานข้อมูล ว่าถูกต้องหรือไม่ หากยังไม่ได้ให้ลองเปลี่ยน localhost เป็น 127.0.0.1 ดู</p>
</blockquote>

<p>เมื่อ migration เสร็จเรียบร้อย ให้เราตรวจสอบฐานข้อมูลจะพบว่ามีตารางใหม่ขึ้นมา 4 ตารางคือ</p>

<ul>
<li><em>itemTable</em> คือข้อมูลรายการ role และ permission ทั้งหมดซึ่งจะเก็บไว้ที่ตาราง <code>auth_item</code></li>
<li><em>itemChildTable</em> เป็นข้อมูลที่บอกว่า role ตัวใหนอยู่ภายใต้ role อะไรบ้างซึ่งเก็บไว้ที่ตาราง  <code>auth_item_child</code></li>
<li><em>assignmentTable</em> เป็นตารางที่ระบุว่า user แต่ละคนมี role เป็นอะไรหรือมีสิทธิ์ทำอะไรบ้าง ตรงนี้จะเป็นตัวระบุ เก็บไว้ที่ตาราง <code>auth_assignment</code></li>
<li><em>ruleTable</em> : เป็นตารางที่เก็บข้อมูลให้กับ Rule เก็บไว้ที่ตาราง <code>auth_rule</code></li>
</ul>

<p>เมื่อตั้งค่าเปิดการใช้งาน authManager และเตรียมฐานข้อมูลเสร็จเรียบร้อย เราก็จะสามารถเรียกใช้งาน <code>authManager</code> ผ่าน Yii::$app ได้ ดังนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x"> $auth = Yii::$app-&gt;authManager;</span>
</code></pre></div>
<p>สามารถดูรายละเอียดเพิ่มเติมว่า DbManager ทำอะไรได้บ้าง <a href="http://www.yiiframework.com/doc-2.0/yii-rbac-dbmanager.html">ได้ที่นี่</a></p>

<h2 id="สร้าง-rbac">สร้าง RBAC</h2>

<p>หลังจากที่เราออกแบบและเปิดการใช้งาน authManager ไว้แล้ว ขั้นตอนต่อไปคือเราจะทำการสร้าง RbacController ซึ่งเป็น Controller แบบ console คือต้องใช้ผ่าน command line เท่านั้น ที่ต้องทำผ่าน command line เพราะปกติการสร้าง rbac เราก็จะทำแค่ครั้งเดียว ยกเว้นว่ามีการแก้ไข role ต่างๆ</p>

<p>เราจะทำการสร้างไฟล์ RbacController ไว้ที่ console/controllers/RbacController.php แล้วสร้างโค้ดตามนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">console\controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Yii</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\helpers\Console</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RbacController</span> <span class="k">extends</span> <span class="nx">\yii\console\Controller</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">actionInit</span><span class="p">(){</span>
     <span class="nx">Console</span><span class="o">::</span><span class="na">output</span><span class="p">(</span><span class="s1">&#39;Yii 2 Learning.&#39;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>เราสร้าง <code>RbacController</code> ขึ้นมาเพื่อใช้ในการสร้าง Rbac หากสังเกตจะพบว่า controller extends ด้วย yii\console\Controller  ซึ่งจะไม่ใช่ controller ปกติที่เราใช้งานกัน ตอนนี้ RbacController มี 1 action คือ Init โดยให้ echo ข้อความออกมาเป็น &quot;Yii 2 Learning&quot;</p>

<p>ทดลองเรียกใช้งาน โดยเปิด command แล้ว cd เข้าไปที่โปรเจคของเรา จากนั้นรันคำสั่ง</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">php yii
</code></pre></div>
<p>จะพบกับข้อความประมาณนี้ ให้สังเกตุด้านล่างจะมี rbac/init ที่เราได้สร้างไว้ขึ้นมาแล้ว</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">This is Yii version 2.0.6.

The following commands are available:

- asset                        Allows you to combine and compress your
                               JavaScript and CSS files.
    asset/compress (default)   Combines and compresses the asset files according
                               to the given configuration.
    asset/template             Creates template of configuration file for
                               [[actionCompress]].
// ......

- rbac
    rbac/init


To see the help of each command, enter:

  yii help &lt;command-name&gt;
</code></pre></div>
<p>เราสามารถเรียกใช้งานได้เลย</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"> php yii rbac/init
</code></pre></div>
<p>จะพบข้อความดังนี้</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Yii 2 Learning
</code></pre></div>
<p>หลังจากทดแล้วแล้วว่าใช้งานได้ ถึงเวลาที่เราจะสร้าง rbac จริงๆ ซึ่งเราได้ออกแบบไว้แล้ว ดูตามภาพ</p>

<p><img src="/img/rbac.jpg" alt=""></p>

<p>ตามที่ออกแบบไว้เราจะแบ่ง role เป็น 4 ประเภท คือ</p>

<ul>
<li>Author สำหรับผู้ที่เขียนบทความ</li>
<li>Editor สำหรับผู้ที่ตรวจสอบบทความ</li>
<li>managerUser สำหรับจัดการข้อมูลผู้ใช้งาน</li>
<li>Admin สำหรับผู้ดูแลระบบ</li>
</ul>

<p>ซึ่งหากดูตามภาพแล้ว admin จะอยู่สูงสุดและให้ role ต่างๆ ไปอยู่ภายใต้ admin เพื่อทีจะให้ admin สามารถทำทุกอย่างได้ ตามที่ role ที่อยู่ภายใต้มีสิทธิ์ทำ</p>

<p>หลังจากนั้นเราจะทำการ assignment ค่า role ให้กับ user ต่างๆ ดังนี้</p>

<ul>
<li>user-a : admin</li>
<li>user-b : editor</li>
<li>user-c : author</li>
<li>user-d : ไม่ต้องให้สิทธิ์ เอาไว้ทดสอบ</li>
</ul>

<p>ในการสร้าง role เราจะเรียกใช้งานผ่าน <code>Yii::$app-&gt;authManager</code> เพื่อทำการสร้าง rbac โดยมีฟังก์ชันหลักๆ ที่ใช้งานดังนี้</p>

<ul>
<li><code>removeAll()</code> เป็นฟังก์ชัน clear ข้อมูล rbac ทั้งหมด โปรดระวังการใช้งานด้วยครับ</li>
<li><code>createRole()</code> เป็นคำสั่งที่เอาไว้สร้าง role</li>
<li><code>add()</code> เป็นคำสั่งบันทึก role,rule,permission ตามที่กำหนด</li>
<li><code>addChild()</code> สามารถกำหนดให้ role,permission ที่ต้องการอยู่ภายใต้ role ใหนก็ได้</li>
<li><code>assign()</code> เป็นคำสั่งที่เอาไว้มอบ role ให้กับ user ที่ต้องการ</li>
</ul>

<p>ให้ทำการสร้าง rbac ตามโค้ดด้านล่างนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">actionInit</span><span class="p">(){</span>

  <span class="nv">$auth</span> <span class="o">=</span> <span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">authManager</span><span class="p">;</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">removeAll</span><span class="p">();</span>
  <span class="nx">Console</span><span class="o">::</span><span class="na">output</span><span class="p">(</span><span class="s1">&#39;Removing All! RBAC.....&#39;</span><span class="p">);</span>

  <span class="nv">$manageUser</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;ManageUser&#39;</span><span class="p">);</span>
  <span class="nv">$manageUser</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับจัดการข้อมูลผู้ใช้งาน&#39;</span><span class="p">;</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$manageUser</span><span class="p">);</span>

  <span class="nv">$author</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">);</span>
  <span class="nv">$author</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการเขียนบทความ&#39;</span><span class="p">;</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$author</span><span class="p">);</span>

  <span class="nv">$editor</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Editor&#39;</span><span class="p">);</span>
  <span class="nv">$editor</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการตรวจสอบบทความ&#39;</span><span class="p">;</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$editor</span><span class="p">);</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$editor</span><span class="p">,</span> <span class="nv">$author</span><span class="p">);</span>

  <span class="nv">$admin</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Admin&#39;</span><span class="p">);</span>
  <span class="nv">$admin</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการดูแลระบบ&#39;</span><span class="p">;</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$admin</span><span class="p">);</span>

  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="nv">$editor</span><span class="p">);</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="nv">$manageUser</span><span class="p">);</span>

  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$editor</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$author</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="nx">Console</span><span class="o">::</span><span class="na">output</span><span class="p">(</span><span class="s1">&#39;Success! RBAC roles has been added.&#39;</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div>
<p>จากนั้นทำการรันคำสั่งเพื่อสร้าง rbac ตาที่ได้ออกแบบไว้</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">php yii rbac/init
</code></pre></div>
<p>จะได้ผลลัพธ์ดังนี้</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Removing All! RBAC.....
Success! RBAC roles has been added.
</code></pre></div>
<p>หลังจากนั้น ให้เราทำการตรวจสอบข้อมูลตารางที่ <code>auth_item</code> จะพบว่ามีข้อมูลขึ้นมาแล้ว 4 แถวซึ่งก็คือ Role ที่เราได้สร้างไว้นั่นเอง</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="n">name</span><span class="p">,</span><span class="k">type</span><span class="p">,</span><span class="n">description</span>  <span class="k">from</span> <span class="n">auth_item</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------+------+-----------------------------------------+</span>
<span class="o">|</span> <span class="n">name</span>       <span class="o">|</span> <span class="k">type</span> <span class="o">|</span> <span class="n">description</span>                             <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+------+-----------------------------------------+</span>
<span class="o">|</span> <span class="k">Admin</span>      <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="err">สำหรับการดูแลระบบ</span>                         <span class="o">|</span>
<span class="o">|</span> <span class="n">Author</span>     <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="err">สำหรับการเขียนบทความ</span>                      <span class="o">|</span>
<span class="o">|</span> <span class="n">Editor</span>     <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="err">สำหรับการตรวจสอบบทความ</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="n">ManageUser</span> <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="err">สำหรับจัดการข้อมูลผู้ใช้งาน</span>                    <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+------+-----------------------------------------+</span>
</code></pre></div>
<p>ในส่วนของ auth_item_child ที่เป็นตารางที่บอกว่า role ใหนอยู่ภายใต้ role อะไร</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">auth_item_child</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
<span class="o">|</span> <span class="n">parent</span> <span class="o">|</span> <span class="n">child</span>      <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
<span class="o">|</span> <span class="n">Editor</span> <span class="o">|</span> <span class="n">Author</span>     <span class="o">|</span>
<span class="o">|</span> <span class="k">Admin</span>  <span class="o">|</span> <span class="n">Editor</span>     <span class="o">|</span>
<span class="o">|</span> <span class="k">Admin</span>  <span class="o">|</span> <span class="n">ManageUser</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
<span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>และสุดท้าย <code>auth_assignment</code> จะเป็นตารางที่บอกว่า user คนใหนมีสิทธิ์อะไรหรือได้รับ role  อะไร</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">auth_assignment</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-----------+---------+------------+</span>
<span class="o">|</span> <span class="n">item_name</span> <span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span> <span class="n">created_at</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+------------+</span>
<span class="o">|</span> <span class="k">Admin</span>     <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">1440296691</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Editor</span>    <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1440296691</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Author</span>    <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1440296691</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+---------+------------+</span>
<span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>สังเกตุ เราไมได้ให้สิทธิ์ user-d เพราะจะเอาไว้ทดสอบเข้าใช้งานในกรณีคนที่ไม่มีสิทธิ์</p>
</blockquote>

<p>เสร็จเรียบร้อย การสร้าง RBAC มันง่ายๆ แค่นี้เอง (แต่กว่าจะเข้าใจก็เล่นเอาเหนื่อยเหมือนกัน อาจจะด้วยภาษาอังกฤษอันอ่อนด้อยของผม)  หลังจากนี้ก็เป็นการตั้งค่าให้ controller ต่างๆ และการสร้างฟอร์ม assignment role ให้กับ user เพื่อให้เราจัดการสิทธิ์ได้ง่ายๆ</p>

<h1 id="รู้จักกับ-access-control-filter">รู้จักกับ Access Control Filter</h1>

<p>ก่อนที่เราจะทำการเรียกใช้งาน rbac ที่เราได้สร้างขึ้น เราต้องทำความเข้าใจกับ  Access Control Filter ใน Controller ก่อน ซึ่งปกติค่า role default อยู่ 2 ตัว ที่เราสามารถเรียกใช้ได้เลยคือ</p>

<ul>
<li>ผู้ใช้งานที่ล็อกอิน (@)</li>
<li>ผู้ใช้งานที่ไม่ได้ล็อกอิน (?)</li>
</ul>

<p>โดยทั้ง 2 ตัวนี้เราสามารถกำหนดค่าในส่วน Access Control ของ Controller ได้ลองดูตัวอย่าง</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">yii\web\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\filters\AccessControl</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SiteController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">behaviors</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;access&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">AccessControl</span><span class="o">::</span><span class="na">className</span><span class="p">(),</span>
                <span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;signup&#39;</span><span class="p">],</span>
                <span class="s1">&#39;rules&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;allow&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                        <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;signup&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;?&#39;</span><span class="p">],</span>
                    <span class="p">],</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;allow&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                        <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;logout&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;@&#39;</span><span class="p">],</span>
                    <span class="p">],</span>
                <span class="p">],</span>
            <span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>Access Control Filter เป็นส่วนของการกำหนดค่าให้แต่ละ action ว่า Role ใหนสามารถเข้าใช้งาน action อะไรได้บ้าง เราสามารถกำหนดค่าเพื่อเปิดใช้งานผ่าน <code>function behaviors()</code> ของ Controller ได้เลยโดยกำหนดภายใน property <code>access</code> หลังจากนั้นก็สามารถระบุได้เลยว่า action ใหนให้เข้าใช้งานยังไง ตัวอย่างเช่น action  <code>logout</code> ต้อง login ก่อนถึงจะทำการเรียกใช้งาน logout ได้ จะสังเกตว่าเราจะใช้ roles เป็นเครื่องหมาย <code>@</code> แปลว่าต้องเป็นคนที่ login มาแล้วเท่านั้น ซึ่งในส่วนของ <code>actions</code> เราจะระบุกี่ action ก็ได้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">[</span>
<span class="x">    &#39;allow&#39; =&gt; true,</span>
<span class="x">    &#39;actions&#39; =&gt; [&#39;logout&#39;],</span>
<span class="x">    &#39;roles&#39; =&gt; [&#39;@&#39;],</span>
<span class="x">],</span>
</code></pre></div>
<p>ส่วนถ้ายังไม่ login ก็ใช้งานได้ 2 action คือ &#39;login&#39;, &#39;signup&#39; และตรง roles ก็กำหนดค่าเป็น <code>?</code> เพื่อระบุว่าเป็นใครก็ได้ที่ยังไม่ได้ login</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">[</span>
<span class="x">    &#39;allow&#39; =&gt; true,</span>
<span class="x">    &#39;actions&#39; =&gt; [&#39;login&#39;, &#39;signup&#39;],</span>
<span class="x">    &#39;roles&#39; =&gt; [&#39;?&#39;],</span>
<span class="x">],</span>
</code></pre></div>
<p>นี่เป็นการใช้งาน Access Control Filter แบบปกติทั่วไป เราจะสามารถควบคุมการเข้าใช้งานได้แค่ ล็อกอิน,ไม่ล็อกอิน  แต่ถ้าหากเราจะควบคุมการเข้าใช้งานหลังจากล็อกอินแล้ว เช่น ผู้ใช้งานบางคนอาจมีสิทธิ์การเข้าใช้งานที่แตกต่างกัน จะไม่สามารถทำได้ ซึ่ง RBAC จะมาช่วยตรงนี้</p>

<p>RBAC ที่เราจะใช้งานก็แค่เปลี่ยน role default <code>@</code>,<code>?</code> ให้เป็นชื่อ Role ตามที่เราได้ตั้งขึ้น</p>

<h1 id="สร้าง-blog-และเรียกใช้งาน-rbac">สร้าง Blog และเรียกใช้งาน RBAC</h1>

<p>เราจะสร้าง Controller เพื่อใช้ในการทดสอบ RBAC ที่เราสร้างขึ้นโดยจะทำระบบ blog ง่ายๆ ให้ทำการสร้างตาราง blog ดังนี้</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">blog</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">title</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;ชื่อเรื่อง&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">content</span><span class="o">`</span> <span class="nb">text</span> <span class="k">COMMENT</span> <span class="s1">&#39;เนื้อหา&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">category</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;หมวดหมู่&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">tag</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;คำค้น&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">created_at</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;สร้างวันที่&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">created_by</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;สร้างโดย&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">updated_at</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;แก้ไขวันที่&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">updated_by</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;แก้ไขโดย&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">title</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">),</span>
  <span class="n">FULLTEXT</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">content</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>
</code></pre></div>
<p>จากนั้นทำการ Gii model ไว้ที่ common/models เพื่อให้สามารถใช้งานได้ทั้ง backend,frontend</p>

<p><img src="/img/rbac-db-gii-model.png" alt=""></p>

<p>เมื่อ Gii model Blog เสร็จเรียบร้อยให้เราทำการ Gii CRUD Blog โดยให้ gii ไว้ที่ frontend</p>

<p><img src="/img/rbac-db-gii-crud.png" alt=""></p>

<blockquote>
<p>สังเกตผมจะไม่เอา BlogSearch ไว้ที่ common นะครับ เพราะในการใช้งาน search มันอาจมีการตั้งค่าหรือมีการเรียกใช้ที่แตกต่างกัน เงื่อนไขในการค้นหาต่างๆ ไม่เหมือนกัน  ถ้าใช้ที่ frontend ก็ gii ไว้ที่ frontend เลย ถ้า backend ก็ gii ไว้ที่ backend เลยจะให้เราทำงานง่ายกว่า เพราะไม่ต้องใช้ไฟล์เดียวกัน</p>
</blockquote>

<p>ปรับแต่ง model ที่ common/models/Blog.php เพื่อให้บันทึกรหัส created_by,updated_by โดยจะใช้ BlameableBehavior<a href="https://dixonsatit.github.io/2015/06/17/blameable-behavior.html"> ดูรายละเดียดเพิ่มเติมที่นี่</a> ส่วน created_at,updated_at ใช้ TimestampBehavior <a href="https://dixonsatit.github.io/2015/06/14/model-behaviors.html">ดูรายละเอียดได้ที่นี่</a> ทั้ง 2 ตัวนี้ระบบจะทำให้อัตโนมัติเราไม่ต้องทำอะไรเลยแค่ตั้งค่าเรียกใช้งานที่ model เลย</p>

<p>เปิดไฟล์ Blog.php ขึ้นมา แล้วทำการเรียกใช้งาน BlameableBehavior,TimestampBehavior จากนั้นตั้งค่าเปิดใช้งานที่ฟังก์ชัน <code>behaviors()</code></p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">yii\behaviors\BlameableBehavior</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\behaviors\TimestampBehavior</span><span class="p">;</span>

<span class="c1">// .....</span>

<span class="k">class</span> <span class="nc">Blog</span> <span class="k">extends</span> <span class="nx">\yii\db\ActiveRecord</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">behaviors</span><span class="p">(){</span>
      <span class="k">return</span> <span class="p">[</span>
        <span class="nx">BlameableBehavior</span><span class="o">::</span><span class="na">className</span><span class="p">(),</span>
        <span class="nx">TimestampBehavior</span><span class="o">::</span><span class="na">className</span><span class="p">()</span>
      <span class="p">];</span>
    <span class="p">}</span>

  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div>
<p>จากนั้นไปที่ /frontend/views/blog/_blog.php ลบฟิวด์ที่ไม่ได้ใช้ออกไปคือ created_at,created_by,updated_at,updated_by เพราะเราใช้ behaviors เป็นตัวกรอกข้อมูลให้เราเอง ฟอร์มก็จะเหลือ 4 ฟิวด์ดังนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">yii\helpers\Html</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\widgets\ActiveForm</span><span class="p">;</span>

<span class="cm">/* @var $this yii\web\View */</span>
<span class="cm">/* @var $model common\models\Blog */</span>
<span class="cm">/* @var $form yii\widgets\ActiveForm */</span>
<span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;div class=&quot;blog-form&quot;&gt;</span>

<span class="x">    </span><span class="cp">&lt;?php</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">begin</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textarea</span><span class="p">([</span><span class="s1">&#39;rows&#39;</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">    </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">(</span><span class="nv">$model</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textInput</span><span class="p">([</span><span class="s1">&#39;maxlength&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">    &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="x">        </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Html</span><span class="o">::</span><span class="na">submitButton</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;Create&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;Update&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isNewRecord</span> <span class="o">?</span> <span class="s1">&#39;btn btn-success&#39;</span> <span class="o">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    </span><span class="cp">&lt;?php</span> <span class="nx">ActiveForm</span><span class="o">::</span><span class="na">end</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">&lt;/div&gt;</span>
</code></pre></div>
<p>ให้ทดลอง login แล้วเข้าใช้งานที่ blog ว่าเข้าใช้งานได้หรือไม่ ทดลอง เพิ่ม,ลบ,แก้ไขข้อมูลดู หากสังเกตุจะมีข้อมูล created_at,created_by ขึ้นมาแล้ว</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">blog</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----+-------+---------+----------+------+------------+------------+------------+------------+</span>
<span class="o">|</span> <span class="n">id</span> <span class="o">|</span> <span class="n">title</span> <span class="o">|</span> <span class="n">content</span> <span class="o">|</span> <span class="n">category</span> <span class="o">|</span> <span class="n">tag</span>  <span class="o">|</span> <span class="n">created_at</span> <span class="o">|</span> <span class="n">created_by</span> <span class="o">|</span> <span class="n">updated_at</span> <span class="o">|</span> <span class="n">updated_by</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------+---------+----------+------+------------+------------+------------+------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="n">sdf</span>   <span class="o">|</span> <span class="n">sdf</span>     <span class="o">|</span>        <span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span>    <span class="o">|</span> <span class="mi">1440302545</span> <span class="o">|</span>          <span class="mi">3</span> <span class="o">|</span> <span class="mi">1440302545</span> <span class="o">|</span>          <span class="mi">3</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------+---------+----------+------+------------+------------+------------+------------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>
<p>ให้ไปที่ไฟล์ BlogCongroller.php เราจะตั้งค่า rbac โดยใช้ข้อมูลจากที่เราได้ออกแบบไว้ข้างต้นคือ</p>

<p><img src="/img/rbac.jpg" alt=""></p>

<p>เปิดไฟล์ BlogCongroller.php ซึ่งของเดิมจะยังไม่มีการเรียกใช้งาน Access Control Filter</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//...</span>

<span class="k">class</span> <span class="nc">BlogController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">behaviors</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;verbs&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">VerbFilter</span><span class="o">::</span><span class="na">className</span><span class="p">(),</span>
                <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">&#39;delete&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span>
                <span class="p">],</span>
            <span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</code></pre></div>
<p>ให้ทำการ use yii\filters\AccessControl;  เพิ่มใช้กำหนดค่าในการเข้าใช้งาน action ต่างๆ ว่า role ใหนให้เค้า action อะไรบ้าง</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">frontend\controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Yii</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">common\models\Blog</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">frontend\models\BlogSearch</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\web\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\web\NotFoundHttpException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\filters\VerbFilter</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\filters\AccessControl</span><span class="p">;</span> <span class="c1">//&lt;&lt;------ Use</span>

<span class="sd">/**</span>
<span class="sd"> * BlogController implements the CRUD actions for Blog model.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">BlogController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">behaviors</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="p">[</span>
          <span class="s1">&#39;verbs&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
              <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">VerbFilter</span><span class="o">::</span><span class="na">className</span><span class="p">(),</span>
              <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                  <span class="s1">&#39;delete&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span>
              <span class="p">],</span>
          <span class="p">],</span>
          <span class="s1">&#39;access&#39;</span><span class="o">=&gt;</span><span class="p">[</span>
            <span class="s1">&#39;class&#39;</span><span class="o">=&gt;</span><span class="nx">AccessControl</span><span class="o">::</span><span class="na">className</span><span class="p">(),</span>
            <span class="s1">&#39;rules&#39;</span><span class="o">=&gt;</span><span class="p">[</span>
              <span class="p">[</span>
                <span class="s1">&#39;allow&#39;</span><span class="o">=&gt;</span><span class="k">true</span><span class="p">,</span>
                <span class="s1">&#39;actions&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;create&#39;</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">],</span>
                <span class="s1">&#39;roles&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;Author&#39;</span><span class="p">]</span>
              <span class="p">],</span>
              <span class="p">[</span>
                <span class="s1">&#39;allow&#39;</span><span class="o">=&gt;</span><span class="k">true</span><span class="p">,</span>
                <span class="s1">&#39;actions&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;delete&#39;</span><span class="p">],</span>
                <span class="s1">&#39;roles&#39;</span><span class="o">=&gt;</span><span class="p">[</span><span class="s1">&#39;Editor&#39;</span><span class="p">]</span>
              <span class="p">]</span>
            <span class="p">]</span>
          <span class="p">]</span>
      <span class="p">];</span>
  <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</code></pre></div>
<p>ถ้าดูตามโค้ดจะเห็นว่า เรากำหนดให้ index,create,update ให้เฉพาะ <code>Author</code> ส่วน action delete ให้เฉพาะ role <code>Editor</code> ขึ้นไป ซึ่งก็จะเป็นลำดับตามภาพที่เราได้กำหนดค่าไว้</p>

<ul>
<li>user-a : admin</li>
<li>user-b : editor</li>
<li>user-c : author</li>
<li>user-d : ไม่ได้กำหนด</li>
</ul>

<h2 id="ลองใช้งาน-user-d">ลองใช้งาน user-d</h2>

<p>ลอง login ด้วย user-d และลองเข้า blog/index ดูจะพบว่าเข้าไม่ได้ เพราะว่าไม่ได้รับสิทธิ์ในการใช้งาน ไม่ว่าจะเข้า action อะไรก็ไม่สามารถเข้าได้ แต่อย่าลืม rbac จะรู้จักแค่ action ที่เรากำหนดไว้ใน actions=&gt;[&#39;xxx&#39;,&#39;xxx&#39;] เท่านั้นนะครับ</p>

<blockquote>
<p>อย่าลืมกำหนด property <code>&#39;action&#39;=&gt;[....]</code> ใน rules ให้ครบทุกตัวด้วยนะครับ มี action กี่ตัวก็ระบุให้ครบ</p>
</blockquote>

<p><img src="/img/rbac-db-forbidden.png" alt=""></p>

<h2 id="ลองใช้งาน-user-c">ลองใช้งาน user-c</h2>

<p>ต่อไปให้ลอง login ด้วย user-c จะเข้าได้ปกติ action index,create,view,update  ตามที่เรากำหนดไว้ใน rules ของ controller</p>

<p><img src="/img/rbac-db-blog.png" alt=""></p>

<p>แต่เราจะไม่สามารถเข้าใช้งาน action Delete ได้ เพราะเรากำหนดว่าต้องเป็น role Editor ขึ้นไปถึงจะสามารถลบได้</p>

<p><img src="/img/rbac-db-forbidden.png" alt=""></p>

<h2 id="ลองใช้งาน-user-b-user-a">ลองใช้งาน user-b,user-a</h2>

<p>ส่วน user-a,user-b ก็จะสามารถเข้าได้เช่นกันและยังสามารถลบได้อีกด้วย เพราะเราระบุว่า user ที่จะลบได้ต้องเป็น สิทธิ์ editor ขึ้นไป ถึงแม้ว่าในส่วน access ของ Controller จะไม่ได้ระบุ role admin,editor ไว้ เพราะ author นั้นอยู่ภายใต้ editor และ admin อีกทีตามลำดับมันจึงสามารถเข้าใช้งานได้นั่นเอง</p>

<p><img src="/img/rbac-db-blog.png" alt=""></p>

<p>สามารถลบข้อมูลได้</p>

<p><img src="/img/rbac-db-confirm-delete.png" alt=""></p>

<p><img src="/img/rbac-db-delete.png" alt=""></p>

<p>ในการตั้งค่า Access Control Filter และ RBAC กับ Controller ก็จะมีประมาณนี้</p>

<h1 id="สร้าง-rule-เพื่อเช็คว่าเป็นเจ้าของบทความหรือไม่">สร้าง Rule เพื่อเช็คว่าเป็นเจ้าของบทความหรือไม่</h1>

<p>ในการใช้งานจริงๆ ถ้าหากเราไม่ใช่คนสร้างบทความ ก็ไม่ควรจะไปแก้ไขบทความหรือลบบทความคนอื่นๆ ได้ ควรจะทำได้เฉพาะของตนเอง  ดังนั้นเราจะสร้าง Rule ขึ้นมา 1 ตัวเพื่อเอาไว้เช็คว่าเป็นเจ้าของบทความจริงหรือไม่ โดยตรวจสอบ user_id ที่ login เข้ามากับ created_by ที่อยู่ในตาราง blog หากเป็นคนๆ เดียวกันก็อนุญาติให้แก้ไขได้</p>

<p>Rule นั้นจะทำงานร่วมกัน Role ถ้าจะให้เข้าใจง่ายๆ Rule เป็นตัวช่วยที่ทำให้ Role ปกติสามารถเขียนฟังก์ชันและรับค่าเพื่อนำไปตรวจสอบตามเงื่อนไขของเราได้</p>

<blockquote>
<p>ไม่รู้ว่าผมเข้าใจถูกหรือปล่าวนะ แต่เท่าที่ทำมามันประมาณนี้ ผิดถูกยังไงแนะนำด้วยนะครับ</p>
</blockquote>

<p>เราจะทำการสร้าง Rule ชื่อ AuthorRule.php เพื่อทำการเช็คว่าผู้ใช้งานเป็นเจ้าของบทความหรือไม่ ให้ทำการสร้างไฟล์ไว้ที่  common/rbac/AuthorRule.php</p>

<blockquote>
<p>หากไม่มีโฟลเดอร์ rbac ให้สร้างได้เลย</p>
</blockquote>

<p>จากนั้นทำการสร้าง Rule ตามโค้ดด้านล่าง</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">common\rbac</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">yii\rbac\Rule</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthorRule</span> <span class="k">extends</span> <span class="nx">Rule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;isAuthor&#39;</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$userId</span><span class="p">,</span> <span class="nv">$item</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;blog&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;blog&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">created_by</span> <span class="o">==</span> <span class="nv">$userId</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
 <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Rule นี้มีหน้าที่รับค่าเข้า model Blog เข้ามาเพื่อตรวจสอบกับฟิวด์ created_by ตรงกับ $userId ที่ login ในตอนนี้หรือไม่ ถ้าใช้ก็ return เป็น true ซึ่งเท่ากับยอมให้เข้าใช้งาน แต่ถ้าหากเป็น false ก็จะ แสดง error forbidden ออกไป ส่วนค่า $userId นั้นมันส่งเข้ามาให้อัตโนมัติเราแค่ตั้งชื่อแล้วก็เรียกใช้งานได้เลย</p>

<p>ในการเรียกใช้งานง่ายมากๆ  แค่ใช้ Yii::$app-&gt;user-&gt;can() เป็นตัวตรวจสอบให้ว่ามีสิทธ์หรือไม่</p>

<ul>
<li>ถ้าใช่ จะ return เป็น true<br></li>
<li>ถ้าไม่จะ  return เป็น false</li>
</ul>

<p>และตัวฟังชันจะทำการรับค่า params 2 ตัวคือ</p>

<ul>
<li>ลำดับแรก เป็นชื่อ Rule</li>
<li>ลำดับที่สอง เป็นค่า parameter ที่เราจะส่งเข้าไปเพื่อตรวจสอบ</li>
</ul>

<p>ต่อไปทำการแก้ไข RbacController ใหม่ดังนี้</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">console\controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Yii</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">yii\helpers\Console</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RbacController</span> <span class="k">extends</span> <span class="nx">\yii\console\Controller</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">actionInit</span><span class="p">(){</span>

      <span class="nv">$auth</span> <span class="o">=</span> <span class="nx">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">authManager</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">removeAll</span><span class="p">();</span>
      <span class="nx">Console</span><span class="o">::</span><span class="na">output</span><span class="p">(</span><span class="s1">&#39;Removing All! RBAC.....&#39;</span><span class="p">);</span>

      <span class="nv">$updateBlog</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createPermission</span><span class="p">(</span><span class="s1">&#39;UpdateBlog&#39;</span><span class="p">);</span>
      <span class="nv">$updateBlog</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;แก้ไขบทความ&#39;</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$updateBlog</span><span class="p">);</span>

      <span class="nv">$authorRole</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">\common\rbac\AuthorRule</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$authorRole</span><span class="p">);</span>

      <span class="nv">$updateOwnBlog</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createPermission</span><span class="p">(</span><span class="s1">&#39;UpdateOwnBlog&#39;</span><span class="p">);</span>
      <span class="nv">$updateOwnBlog</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;แก้ไขเฉพาะบทความของตัวเอง&#39;</span><span class="p">;</span>
      <span class="nv">$updateOwnBlog</span><span class="o">-&gt;</span><span class="na">ruleName</span> <span class="o">=</span> <span class="nv">$authorRole</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$updateOwnBlog</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$updateOwnBlog</span><span class="p">,</span><span class="nv">$updateBlog</span><span class="p">);</span>

      <span class="nv">$manageUser</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;ManageUser&#39;</span><span class="p">);</span>
      <span class="nv">$manageUser</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับจัดการข้อมูลผู้ใช้งาน&#39;</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$manageUser</span><span class="p">);</span>

      <span class="nv">$author</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">);</span>
      <span class="nv">$author</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการเขียนบทความ&#39;</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$author</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$author</span><span class="p">,</span> <span class="nv">$updateOwnBlog</span><span class="p">);</span>

      <span class="nv">$editor</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Editor&#39;</span><span class="p">);</span>
      <span class="nv">$editor</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการตรวจสอบบทความ&#39;</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$editor</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$editor</span><span class="p">,</span> <span class="nv">$author</span><span class="p">);</span>

      <span class="nv">$admin</span> <span class="o">=</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">createRole</span><span class="p">(</span><span class="s1">&#39;Admin&#39;</span><span class="p">);</span>
      <span class="nv">$admin</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="s1">&#39;สำหรับการดูแลระบบ&#39;</span><span class="p">;</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$admin</span><span class="p">);</span>

      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="nv">$editor</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">addChild</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="nv">$manageUser</span><span class="p">);</span>

      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$admin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$editor</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nv">$auth</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="nv">$author</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

      <span class="nx">Console</span><span class="o">::</span><span class="na">output</span><span class="p">(</span><span class="s1">&#39;Success! RBAC roles has been added.&#39;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">\Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">can</span><span class="p">(</span><span class="s1">&#39;updatePost&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span> <span class="o">=&gt;</span> <span class="nv">$post</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// update post</span>
<span class="p">}</span>
</code></pre></div></section>
</article>

<!-- Post navigation -->


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'dixonsatit';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
<script src="/js/main.js"></script>


<footer class="site-footer">
	<p class="text"><a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/"><img alt="สัญญาอนุญาตของครีเอทีฟคอมมอนส์" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/th/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Yii2 Learning</span> โดย <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.dimpled.me" property="cc:attributionName" rel="cc:attributionURL">Satit Seethaphon</a> ผลงานนี้ ใช้ <a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/th/" > สัญญาอนุญาตของครีเอทีฟคอมมอนส์แบบ แสดงที่มา-ไม่ใช้เพื่อการค้า 3.0 ประเทศไทย</a>.<br> Powered by <a href="http://jekyllrb.com">Jekyll</a> with <a href="https://rohanchandra.github.io/project/type/">Type Theme</a>
</p>
</footer>


  </body>
</html>
